<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ADM - SEMEC</title>
<style>
  :root{--p:#1f2d3d;--i:#2980b9;--d:#e74c3c;--s:#27ae60;--b:#e6eaee;--bg:#f4f7f6;--m:#6b7a80;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,system-ui,Arial;background:var(--bg);color:#122}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .card{background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  h1{margin:0;color:var(--p);font-size:18px}
  .sub{margin-top:6px;color:var(--m);font-weight:800;font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  label{font-size:11px;font-weight:900;color:var(--m);text-transform:uppercase}
  input{padding:10px;border:1px solid #dfe6ee;border-radius:10px;font-size:14px;outline:none;background:#fff}
  input:focus{border-color:var(--i)}
  button{border:none;border-radius:10px;padding:10px 12px;font-weight:900;cursor:pointer;color:#fff}
  .btn{background:var(--i)}
  .btnS{background:var(--s)}
  .btnD{background:var(--d)}
  .btnG{background:#eef2f6;color:#223;border:1px solid var(--b)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  th{background:var(--p);color:#fff;text-align:left;padding:10px;font-size:12px;white-space:nowrap}
  td{padding:9px;border-bottom:1px solid #edf0f3;font-size:13px;vertical-align:top}
  .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .kpi{border:1px solid var(--b);border-radius:12px;padding:12px;background:#fbfcfd}
  .kpi .t{font-size:11px;font-weight:900;color:var(--m);text-transform:uppercase}
  .kpi .v{font-size:18px;font-weight:1000;color:var(--p);margin-top:2px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  .muted{color:var(--m);font-weight:800;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">

  <div class="card" id="loginCard">
    <h1>ADM – SEMEC (Consolidador)</h1>
    <div class="sub">Login do administrador</div>
    <div class="row" style="margin-top:12px;">
      <div>
        <label>Senha</label><br/>
        <input id="admPass" type="password" placeholder="Senha ADM" />
      </div>
      <button class="btn" onclick="login()">Entrar</button>
      <div class="muted" id="loginMsg"></div>
    </div>
  </div>

  <div class="card hidden" id="admCard" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <h1>ADM – Relatórios Recebidos</h1>
        <div class="sub">Resumo geral + pesquisa por matrícula + lista de envios</div>
      </div>
      <div class="row" style="align-items:center;">
        <button class="btnG" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Período</label><br/>
        <input id="period" type="month" />
      </div>
      <div>
        <label>Matrícula</label><br/>
        <input id="mat" class="mono" placeholder="Ex: 110" />
      </div>
      <button class="btn" onclick="carregarTudo()">Atualizar</button>
      <button class="btnS" onclick="buscarMatricula()">Resumo matrícula</button>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div>
        <h2 style="margin:0;color:#1f2d3d;font-size:14px;">Resumo Geral</h2>
        <div class="muted">Somatório de todos registros (filtrável por período)</div>
        <div class="kpis" style="margin-top:10px;">
          <div class="kpi"><div class="t">Registros</div><div class="v" id="kReg">0</div></div>
          <div class="kpi"><div class="t">Horas extras</div><div class="v" id="kHE">0</div></div>
          <div class="kpi"><div class="t">Faltas c/ atestado</div><div class="v" id="kFA">0</div></div>
          <div class="kpi"><div class="t">Faltas s/ atestado</div><div class="v" id="kFS">0</div></div>
        </div>
        <div class="muted" style="margin-top:10px;"><b>Total faltas:</b> <span id="kFT">0</span></div>
      </div>

      <div>
        <h2 style="margin:0;color:#1f2d3d;font-size:14px;">Resumo por Matrícula</h2>
        <div class="muted">Pesquisa individual (opcional por período)</div>
        <div id="matResumo" class="muted" style="margin-top:10px;">—</div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #e6eaee;margin:14px 0">

    <h2 style="margin:0;color:#1f2d3d;font-size:14px;">Envios recentes</h2>
    <div class="muted" style="margin-top:6px;">Clique em “Atualizar” para ver os últimos envios.</div>

    <div style="overflow:auto;margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Fonte</th>
            <th>Data</th>
            <th>Qtd registros</th>
          </tr>
        </thead>
        <tbody id="uploadsTbody"></tbody>
      </table>
    </div>

    <hr style="border:none;border-top:1px solid #e6eaee;margin:14px 0">

    <h2 style="margin:0;color:#1f2d3d;font-size:14px;">Registros (amostra)</h2>
    <div class="muted">Filtra por período e/ou matrícula</div>
    <div style="overflow:auto;margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Fonte</th>
            <th>Período</th>
            <th>Matrícula</th>
            <th>Nome</th>
            <th>HE</th>
            <th>FaltaA</th>
            <th>FaltaS</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="recordsTbody"></tbody>
      </table>
    </div>

  </div>

</div>

<script>
let token = localStorage.getItem("ADM_TOKEN") || "";

function api(path, opts={}){
  const headers = opts.headers || {};
  if (token) headers["Authorization"] = "Bearer " + token;
  if (!headers["Content-Type"] && opts.body) headers["Content-Type"] = "application/json";
  return fetch(path, { ...opts, headers });
}

async function login(){
  const pass = document.getElementById("admPass").value;
  const msg = document.getElementById("loginMsg");
  msg.textContent = "Entrando...";
  const r = await fetch("/api/auth/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ password: pass })
  });
  if (!r.ok){
    msg.textContent = "Senha inválida.";
    return;
  }
  const data = await r.json();
  token = data.token;
  localStorage.setItem("ADM_TOKEN", token);
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("admCard").classList.remove("hidden");
  carregarTudo();
}

function logout(){
  token = "";
  localStorage.removeItem("ADM_TOKEN");
  document.getElementById("admCard").classList.add("hidden");
  document.getElementById("loginCard").classList.remove("hidden");
}

async function carregarTudo(){
  const period = document.getElementById("period").value;

  // summary geral
  const s = await api("/api/admin/summary" + (period ? `?period=${encodeURIComponent(period)}` : ""));
  const sum = await s.json();
  document.getElementById("kReg").textContent = sum.registros ?? 0;
  document.getElementById("kHE").textContent = sum.horas_extras ?? 0;
  document.getElementById("kFA").textContent = sum.falta_atestado ?? 0;
  document.getElementById("kFS").textContent = sum.falta_sem_atestado ?? 0;
  document.getElementById("kFT").textContent = sum.total_faltas ?? 0;

  // uploads
  const u = await api("/api/admin/uploads?limit=50");
  const up = await u.json();
  const ut = document.getElementById("uploadsTbody");
  ut.innerHTML = (up.uploads || []).map(x=>`
    <tr>
      <td class="mono">${x.id}</td>
      <td>${x.source}</td>
      <td class="mono">${(x.created_at || "").slice(0,19).replace("T"," ")}</td>
      <td>${x.count}</td>
    </tr>
  `).join("");

  // records (amostra)
  const mat = document.getElementById("mat").value.trim();
  const qs = [];
  if (period) qs.push("period=" + encodeURIComponent(period));
  if (mat) qs.push("matricula=" + encodeURIComponent(mat));
  const rr = await api("/api/admin/records" + (qs.length ? ("?" + qs.join("&")) : ""));
  const rows = await rr.json();

  const rt = document.getElementById("recordsTbody");
  rt.innerHTML = (rows.records || []).map(r=>`
    <tr>
      <td>${r.source}</td>
      <td class="mono">${r.period || ""}</td>
      <td class="mono">${r.matricula || ""}</td>
      <td>${r.nome || ""}</td>
      <td>${r.horas_extras || 0}</td>
      <td>${r.falta_atestado || 0}</td>
      <td>${r.falta_sem_atestado || 0}</td>
      <td>${(r.obs || "").replace(/\n/g,"<br>")}</td>
    </tr>
  `).join("");

  document.getElementById("matResumo").innerHTML = "—";
}

async function buscarMatricula(){
  const mat = document.getElementById("mat").value.trim();
  const period = document.getElementById("period").value;
  if (!mat) return alert("Digite uma matrícula.");

  const url = "/api/admin/matricula/" + encodeURIComponent(mat) + "/summary" + (period ? `?period=${encodeURIComponent(period)}` : "");
  const r = await api(url);
  const s = await r.json();
  if (r.ok === false || s.error){
    document.getElementById("matResumo").innerHTML = "Nenhum dado encontrado.";
    return;
  }
  document.getElementById("matResumo").innerHTML = `
    <div><b>Matrícula:</b> <span class="mono">${s.matricula}</span></div>
    <div><b>Nome:</b> ${s.nome || "-"}</div>
    <div><b>Função:</b> ${s.funcao || "-"}</div>
    <div><b>Vínculo:</b> ${s.vinculo || "-"}</div>
    <div><b>Carga:</b> ${s.carga || "-"}</div>
    <hr style="border:none;border-top:1px solid #e6eaee;margin:10px 0">
    <div><b>Registros:</b> ${s.registros || 0}</div>
    <div><b>Horas extras:</b> ${s.horas_extras || 0}</div>
    <div><b>Falta c/ atestado:</b> ${s.falta_atestado || 0}</div>
    <div><b>Falta s/ atestado:</b> ${s.falta_sem_atestado || 0}</div>
    <div><b>Total faltas:</b> ${s.total_faltas || 0}</div>
  `;
}

if (token){
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("admCard").classList.remove("hidden");
  carregarTudo();
}
</script>
</body>
</html>

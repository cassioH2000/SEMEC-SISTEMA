<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEMEC ‚Ä¢ Admin</title>

  <style>
    :root{
      --bg:#0b1220;
      --line: rgba(255,255,255,0.08);
      --text:#e5e7eb;
      --muted:#a9b0c2;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,0.16), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(168,85,247,0.15), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .topbar{
      padding:18px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,0.14);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .wrap{ max-width:1200px; margin:0 auto; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .badge{
      font-size:12px; padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; background: rgba(255,255,255,0.06); color:var(--muted);
    }
    .status{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); }
    .dot{ width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,0.2); border:1px solid var(--line); }
    .dot.ok{ background: rgba(34,197,94,0.9); }
    .dot.bad{ background: rgba(239,68,68,0.9); }
    main{ padding:18px 16px 40px; }
    .grid{ display:grid; grid-template-columns: 1.1fr 0.9fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,0.14);
    }
    .card .head h2{ margin:0; font-size:14px; letter-spacing: 0.2px; }
    .card .content{ padding:14px 16px; }

    .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .controls{ grid-template-columns: 1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%; padding:10px 10px; border-radius: 12px;
      border:1px solid var(--line); background: rgba(0,0,0,0.18);
      color:var(--text); outline:none;
    }
    textarea{ resize: vertical; }
    .btn{
      padding:10px 12px; border-radius: 12px; border:1px solid var(--line);
      background: rgba(255,255,255,0.06); color:var(--text); cursor:pointer;
      transition: 0.15s ease; font-weight: 600;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.10); }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; transform:none; }
    .btn.primary{ border-color: rgba(59,130,246,0.55); background: rgba(59,130,246,0.18); }
    .btn.danger{ border-color: rgba(239,68,68,0.55); background: rgba(239,68,68,0.12); }
    .btn.ghost{ background: transparent; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .kpis{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }
    .kpi{
      border:1px solid var(--line); border-radius: 14px; padding:12px;
      background: rgba(0,0,0,0.12);
    }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:22px; font-weight: 800; margin-top:4px; }

    table{ width:100%; border-collapse: separate; border-spacing:0; min-width: 920px; }
    thead th{
      position: sticky; top: 0;
      background: rgba(0,0,0,0.22); backdrop-filter: blur(8px);
      z-index: 2; text-align:left; font-size:12px; color:var(--muted);
      padding:10px 10px; border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:10px 10px; border-bottom:1px solid rgba(255,255,255,0.06);
      font-size:13px; vertical-align: top;
    }
    tbody tr:hover td{ background: rgba(255,255,255,0.03); }

    .hint{ font-size:12px; color: var(--muted); }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: rgba(255,255,255,0.06); display:inline-block;
    }
    .msg{
      margin-top:10px; padding:10px 12px; border-radius: 12px;
      border:1px solid var(--line); background: rgba(255,255,255,0.06);
      display:none;
    }
    .msg.ok{ border-color: rgba(34,197,94,0.55); background: rgba(34,197,94,0.10); }
    .msg.err{ border-color: rgba(239,68,68,0.55); background: rgba(239,68,68,0.10); }
    .msg.warn{ border-color: rgba(245,158,11,0.55); background: rgba(245,158,11,0.10); }

    .overlay{
      position:fixed; inset:0; background: rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center; padding:18px; z-index: 10;
    }
    .modal{
      width: min(540px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{ padding:14px 16px; border-bottom:1px solid var(--line); background: rgba(0,0,0,0.18); }
    .modal .mhead h3{ margin:0; font-size:14px; }
    .modal .mbody{ padding:16px; }
    .modal .merr{ margin-top:10px; color:#fecaca; font-size:13px; display:none; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .grid2{ grid-template-columns: 1fr; } }
    .kbd{
      padding:2px 6px; border:1px solid var(--line); border-radius:8px;
      background: rgba(0,0,0,0.25);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
    }

    /* =========================
       PDF PROFISSIONAL - PREFEITURA (PRINT)
       ========================= */
    @media print {

      @page{
        size: A4 landscape;
        margin: 12mm;
      }

      body{
        background:#fff !important;
        color:#000 !important;
      }

      /* Esconde tudo que n√£o deve ir pro PDF */
      .topbar, .controls, .actions, #msgBox, #loginOverlay, #editOverlay{
        display:none !important;
      }

      /* Remove "cards" do tema escuro */
      .card{
        box-shadow:none !important;
        border:none !important;
        background:#fff !important;
      }

      /* Mostra apenas a √°rea do relat√≥rio */
      #printArea{
        display:block !important;
      }

      /* Cabe√ßalho institucional */
      .pdf-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border: 1px solid #000;
        padding:10px 12px;
        margin-bottom:10px;
      }

      .pdf-left, .pdf-right{
        width:120px;
        height:60px;
        border: 1px solid #000;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:10px;
        text-align:center;
        line-height:1.1;
      }

      .pdf-center{
        flex:1;
        text-align:center;
        line-height:1.15;
      }

      .pdf-center .t1{
        font-size:14px;
        font-weight:800;
        letter-spacing:0.2px;
      }

      .pdf-center .t2{
        font-size:12px;
        font-weight:700;
        margin-top:2px;
      }

      .pdf-center .t3{
        font-size:11px;
        margin-top:4px;
      }

      /* Tabela */
      table{
        width:100% !important;
        border-collapse:collapse !important;
        font-size:10.5px !important;
      }

      thead th{
        position:static !important;
        background:#000 !important;
        color:#fff !important;
        border:1px solid #000 !important;
        padding:6px 6px !important;
        text-align:left !important;
      }

      tbody td{
        border:1px solid #000 !important;
        padding:6px 6px !important;
        vertical-align:top !important;
      }

      tbody tr:nth-child(even) td{
        background:#f2f2f2 !important;
      }

      /* Totais */
      .pdf-totals{
        margin:10px 0 10px;
        border:1px solid #000;
        padding:8px 10px;
        font-size:11px;
      }

      .pdf-footer{
        position:fixed;
        left: 12mm;
        right: 12mm;
        bottom: 8mm;
        border-top:1px solid #000;
        padding-top:6px;
        font-size:10px;
        display:flex;
        justify-content:space-between;
      }

      .pageNumber:before { content: counter(page); }
      .totalPages:before { content: counter(pages); }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div class="overlay" id="loginOverlay">
    <div class="modal">
      <div class="mhead"><h3>üîí Admin SEMEC</h3></div>
      <div class="mbody">
        <div class="hint" style="margin-bottom:8px;">Digite a senha do Admin para acessar.</div>
        <label for="adminPass">Senha</label>
        <input id="adminPass" type="password" placeholder="Senha do admin..." />
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
          <button class="btn primary" id="btnLogin" type="button">‚úÖ Entrar</button>
        </div>
        <div class="merr" id="loginErr">Senha inv√°lida.</div>
        <div class="hint" style="margin-top:10px;">
          (A senha √© a vari√°vel <span class="kbd">ADMIN_PASSWORD</span> no Render.)
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR (CADASTRO + FOLHA DO M√äS) -->
  <div class="overlay" id="editOverlay" style="display:none;">
    <div class="modal">
      <div class="mhead"><h3>‚úèÔ∏è Editar Funcion√°rio</h3></div>
      <div class="mbody">

        <div class="grid2">
          <div>
            <label>Matr√≠cula</label>
            <input id="e_matricula" type="text" disabled />
          </div>
          <div>
            <label>Escola</label>
            <input id="e_escola" type="text" placeholder="Escola" />
          </div>
          <div>
            <label>Nome</label>
            <input id="e_nome" type="text" placeholder="Nome" />
          </div>
          <div>
            <label>Fun√ß√£o</label>
            <input id="e_funcao" type="text" placeholder="Fun√ß√£o" />
          </div>
          <div>
            <label>V√≠nculo</label>
            <input id="e_vinculo" type="text" placeholder="V√≠nculo" />
          </div>
          <div>
            <label>Carga</label>
            <input id="e_carga" type="text" placeholder="Carga" />
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.08); margin:14px 0;">

        <div id="folhaBox" style="display:none;">
          <div class="hint" style="margin-bottom:8px;"><b>Folha do m√™s</b> (per√≠odo selecionado no topo)</div>

          <div class="grid2">
            <div>
              <label>Per√≠odo</label>
              <input id="e_periodo" type="text" disabled />
            </div>

            <div>
              <label>HE (horas extras)</label>
              <input id="e_he" type="number" min="0" step="1" placeholder="Ex.: 10" />
            </div>

            <div>
              <label>Faltas (total)</label>
              <input id="e_faltas" type="number" min="0" step="1" placeholder="Ex.: 2" />
            </div>

            <div>
              <label>Falta com atestado</label>
              <input id="e_falta_com_atestado" type="number" min="0" step="1" placeholder="Ex.: 1" />
            </div>

            <div style="grid-column:1 / -1;">
              <label>Observa√ß√µes</label>
              <textarea id="e_obs" rows="3" placeholder="Observa√ß√µes do m√™s..."></textarea>
            </div>
          </div>

          <div class="hint" style="margin-top:8px;">
            ‚Ä¢ <b>Faltas</b> e <b>Falta com atestado</b> s√£o lan√ßadas <b>separadas</b>.
          </div>
        </div>

        <div class="merr" id="editErr">Erro ao salvar.</div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
          <button class="btn ghost" id="btnCancelarEdicao" type="button">Cancelar</button>
          <button class="btn primary" id="btnSalvarEdicao" type="button">üíæ Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div style="font-weight:900;">SEMEC</div>
          <span class="badge">Admin ‚Ä¢ Folha de Ponto</span>
        </div>
        <div class="status">
          <span class="dot" id="dotApi"></span>
          <span>API: <b id="apiStatus">‚Äî</b></span>
          <span style="opacity:.55;">‚Ä¢</span>
          <span>Token: <b id="tokenStatus">‚Äî</b></span>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div class="wrap">

      <!-- ===== √ÅREA DO PDF (S√ì APARECE NO PRINT) ===== -->
      <div id="printArea" style="display:none;">
        <div class="pdf-header">
          <div class="pdf-left">LOGO<br>PREFEITURA</div>

          <div class="pdf-center">
            <div class="t1">SECRETARIA MUNICIPAL DE EDUCA√á√ÉO</div>
            <div class="t2">RELAT√ìRIO MENSAL ‚Äì FOLHA DE PONTO</div>
            <div class="t3" id="pdfPeriodoTxt">Per√≠odo: ‚Äî</div>
          </div>

          <div class="pdf-right">LOGO<br>SEMEC</div>
        </div>

        <div class="pdf-totals" id="pdfTotalsBox"></div>

        <div class="pdf-footer">
          <div id="pdfEmitidoEm">Emitido em: ‚Äî</div>
          <div>P√°gina <span class="pageNumber"></span> de <span class="totalPages"></span></div>
        </div>
      </div>
      <!-- ===== FIM √ÅREA DO PDF ===== -->

      <div class="grid">
        <section class="card">
          <div class="head"><h2>Controles</h2><span class="pill">Admin</span></div>
          <div class="content">
            <div class="controls">
              <div>
                <label>Per√≠odo (m√™s)</label>
                <input id="periodo" type="month" />
                <div class="hint" style="margin-top:6px;">Use para carregar o relat√≥rio do m√™s.</div>
              </div>
              <div>
                <label>Filtrar por escola</label>
                <select id="filtroEscola"><option value="">Todas</option></select>
              </div>
              <div>
                <label>Pesquisar (nome ou matr√≠cula)</label>
                <input id="pesquisa" type="text" placeholder="Digite para filtrar..." />
              </div>
            </div>

            <div class="actions" style="margin-top:12px;">
              <button class="btn primary" id="btnCarregarMes" type="button">üìÖ Carregar M√™s</button>
              <button class="btn" id="btnCarregarCadastro" type="button">üë• Cadastro</button>
              <button class="btn" id="btnPDF" type="button">üßæ Gerar PDF</button>
              <button class="btn danger" id="btnSair" type="button">üö™ Sair</button>
            </div>

            <div id="msgBox" class="msg"></div>
          </div>
        </section>

        <section class="card">
          <div class="head"><h2>Resumo</h2><span class="hint">KPIs do m√™s carregado</span></div>
          <div class="content">
            <div class="kpis">
              <div class="kpi"><div class="t">Total funcion√°rios</div><div class="v" id="kpiTotalFunc">0</div></div>
              <div class="kpi"><div class="t">Com folha lan√ßada</div><div class="v" id="kpiComFolha">0</div></div>
              <div class="kpi"><div class="t">Faltas (soma)</div><div class="v" id="kpiFaltas">0</div></div>
              <div class="kpi"><div class="t">HE (soma)</div><div class="v" id="kpiHE">0</div></div>
            </div>

            <div class="hint" style="margin-top:10px;">
              ‚Ä¢ O bot√£o <b>Editar</b> edita cadastro e a folha do m√™s (faltas / com atestado / HE / obs).
            </div>
          </div>
        </section>
      </div>

      <section class="card" style="margin-top:14px;">
        <div class="head">
          <h2 id="tableTitle">Lista</h2>
          <span id="tableSubtitle">‚Äî</span>
        </div>
        <div class="content">
          <div style="overflow:auto;">
            <table id="tabelaRelatorio">
              <thead>
                <tr>
                  <th>Escola</th>
                  <th>Matr√≠cula</th>
                  <th>Nome</th>
                  <th>Fun√ß√£o</th>
                  <th>V√≠nculo</th>
                  <th>Carga</th>
                  <th>Faltas</th>
                  <th>Com atestado</th>
                  <th>HE</th>
                  <th>Obs</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="11" class="hint">Carregue um m√™s para visualizar.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="hint" style="margin-top:10px;">Clique em <b>Editar</b> para alterar dados.</div>
        </div>
      </section>

    </div>
  </main>

  <script>
    // ====== API ======
    const API_HEALTH = "/api/health";
    const API_LOGIN = "/api/login";
    const API_CADASTRO = "/api/admin/funcionarios";
    const API_MES = "/api/admin/mes"; // ?periodo=YYYY-MM
    const API_EDIT = (mat) => "/api/admin/funcionarios/" + encodeURIComponent(mat);
    const API_ENVIAR_FOLHA = "/api/folha/enviar"; // salva folha (UPSERT)

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);

    const loginOverlay = $("loginOverlay");
    const adminPass = $("adminPass");
    const btnLogin = $("btnLogin");
    const loginErr = $("loginErr");

    const editOverlay = $("editOverlay");
    const e_matricula = $("e_matricula");
    const e_escola = $("e_escola");
    const e_nome = $("e_nome");
    const e_funcao = $("e_funcao");
    const e_vinculo = $("e_vinculo");
    const e_carga = $("e_carga");

    const folhaBox = $("folhaBox");
    const e_periodo = $("e_periodo");
    const e_he = $("e_he");
    const e_faltas = $("e_faltas");
    const e_falta_com_atestado = $("e_falta_com_atestado");
    const e_obs = $("e_obs");

    const btnSalvarEdicao = $("btnSalvarEdicao");
    const btnCancelarEdicao = $("btnCancelarEdicao");
    const editErr = $("editErr");

    const dotApi = $("dotApi");
    const apiStatus = $("apiStatus");
    const tokenStatus = $("tokenStatus");

    const periodo = $("periodo");
    const filtroEscola = $("filtroEscola");
    const pesquisa = $("pesquisa");

    const btnCarregarMes = $("btnCarregarMes");
    const btnCarregarCadastro = $("btnCarregarCadastro");
    const btnPDF = $("btnPDF");
    const btnSair = $("btnSair");

    const msgBox = $("msgBox");
    const tbody = $("tbody");
    const tableTitle = $("tableTitle");
    const tableSubtitle = $("tableSubtitle");

    const kpiTotalFunc = $("kpiTotalFunc");
    const kpiComFolha = $("kpiComFolha");
    const kpiFaltas = $("kpiFaltas");
    const kpiHE = $("kpiHE");

    // PDF area
    const pdfPeriodoTxt = $("pdfPeriodoTxt");
    const pdfTotalsBox = $("pdfTotalsBox");
    const pdfEmitidoEm = $("pdfEmitidoEm");
    const printArea = $("printArea");

    // ====== STATE ======
    let token = localStorage.getItem("semec_admin_token") || "";
    let lastRows = [];
    let currentPeriodo = "";
    let currentMode = "mes"; // "mes" | "cadastro"

    // ====== UTIL ======
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function defaultPeriodo(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    function showMsg(text, type){
      msgBox.className = "msg " + (type || "");
      msgBox.textContent = text;
      msgBox.style.display = "block";
      setTimeout(() => { msgBox.style.display = "none"; }, 7000);
    }

    function setApiDot(state){
      dotApi.classList.remove("ok","bad");
      if(state === "ok") dotApi.classList.add("ok");
      else if(state === "bad") dotApi.classList.add("bad");
    }

    async function checkApi(){
      try{
        const r = await fetch(API_HEALTH, { method:"GET" });
        const j = await r.json().catch(() => ({}));
        if(r.ok && j.ok){
          apiStatus.textContent = j.db ? "online (db ok)" : "online (db off)";
          setApiDot("ok");
        } else {
          apiStatus.textContent = "online? (erro)";
          setApiDot("bad");
        }
      }catch(e){
        apiStatus.textContent = "offline";
        setApiDot("bad");
      }
    }

    function authHeaders(){
      return token ? { "Authorization": "Bearer " + token } : {};
    }

    function ensureLogged(){
      if(!token){
        loginOverlay.style.display = "flex";
        tokenStatus.textContent = "off";
        return false;
      }
      loginOverlay.style.display = "none";
      tokenStatus.textContent = "ok";
      return true;
    }

    // ====== LOGIN ======
    async function doLogin(){
      loginErr.style.display = "none";
      const pass = String(adminPass.value || "").trim();
      if(!pass){
        loginErr.textContent = "Digite a senha.";
        loginErr.style.display = "block";
        return;
      }

      btnLogin.disabled = true;
      btnLogin.textContent = "Entrando...";

      try{
        const r = await fetch(API_LOGIN, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ password: pass })
        });
        const j = await r.json().catch(() => ({}));

        if(!r.ok || !j.ok || !j.token){
          loginErr.textContent = j.error || "Senha inv√°lida.";
          loginErr.style.display = "block";
          return;
        }

        token = j.token;
        localStorage.setItem("semec_admin_token", token);
        ensureLogged();
        showMsg("‚úÖ Login realizado!", "ok");
        await carregarMes();

      }catch(e){
        loginErr.textContent = "Erro de conex√£o.";
        loginErr.style.display = "block";
      }finally{
        btnLogin.disabled = false;
        btnLogin.textContent = "‚úÖ Entrar";
      }
    }

    btnLogin.addEventListener("click", doLogin);
    adminPass.addEventListener("keydown", (e) => { if(e.key === "Enter") doLogin(); });

    // ====== EDITAR ======
    function openEditModal(row){
      editErr.style.display = "none";

      e_matricula.value = row.matricula || "";
      e_escola.value = row.escola || "";
      e_nome.value = row.nome || "";
      e_funcao.value = row.funcao || "";
      e_vinculo.value = row.vinculo || "";
      e_carga.value = row.carga || "";

      if(currentMode === "mes"){
        folhaBox.style.display = "block";
        e_periodo.value = row.periodo || currentPeriodo || "";
        e_he.value = (row.horas_extras ?? "");
        e_faltas.value = (row.faltas ?? "");
        e_falta_com_atestado.value = (row.falta_com_atestado ?? "");
        e_obs.value = (row.observacoes ?? "");
      }else{
        folhaBox.style.display = "none";
      }

      editOverlay.style.display = "flex";
    }

    function closeEditModal(){ editOverlay.style.display = "none"; }
    btnCancelarEdicao.addEventListener("click", closeEditModal);

    async function salvarEdicao(){
      if(!ensureLogged()) return;

      const mat = e_matricula.value.trim();
      if(!mat) return;

      btnSalvarEdicao.disabled = true;
      btnSalvarEdicao.textContent = "Salvando...";

      try{
        // 1) salva cadastro
        const bodyCadastro = {
          escola: e_escola.value.trim(),
          nome: e_nome.value.trim(),
          funcao: e_funcao.value.trim(),
          vinculo: e_vinculo.value.trim(),
          carga: e_carga.value.trim()
        };

        const r1 = await fetch(API_EDIT(mat), {
          method:"PUT",
          headers:{ "Content-Type":"application/json", ...authHeaders() },
          body: JSON.stringify(bodyCadastro)
        });

        const j1 = await r1.json().catch(() => ({}));
        if(!r1.ok || !j1.ok){
          editErr.textContent = j1.error || "Erro ao salvar cadastro.";
          editErr.style.display = "block";
          return;
        }

        // 2) salva folha do m√™s
        if(currentMode === "mes"){
          const periodoSel = (currentPeriodo || e_periodo.value || "").trim();
          if(!periodoSel){
            editErr.textContent = "Selecione um per√≠odo (m√™s) antes de salvar a folha.";
            editErr.style.display = "block";
            return;
          }

          const faltas = Number(e_faltas.value || 0);
          const faltaCom = Number(e_falta_com_atestado.value || 0);
          const he = Number(e_he.value || 0);

          if(faltas < 0 || faltaCom < 0 || he < 0){
            editErr.textContent = "N√£o √© permitido valor negativo.";
            editErr.style.display = "block";
            return;
          }

          const bodyFolha = {
            periodo: periodoSel,
            matricula: mat,
            escola: bodyCadastro.escola,
            nome: bodyCadastro.nome,
            funcao: bodyCadastro.funcao,
            vinculo: bodyCadastro.vinculo,
            carga: bodyCadastro.carga,
            faltas: Number.isNaN(faltas) ? 0 : faltas,
            falta_com_atestado: Number.isNaN(faltaCom) ? 0 : faltaCom,
            horas_extras: Number.isNaN(he) ? 0 : he,
            observacoes: String(e_obs.value || "").trim()
          };

          const r2 = await fetch(API_ENVIAR_FOLHA, {
            method:"POST",
            headers:{ "Content-Type":"application/json", ...authHeaders() },
            body: JSON.stringify(bodyFolha)
          });

          const j2 = await r2.json().catch(() => ({}));
          if(!r2.ok || !j2.ok){
            editErr.textContent = j2.error || "Erro ao salvar folha do m√™s.";
            editErr.style.display = "block";
            return;
          }
        }

        showMsg("‚úÖ Atualizado com sucesso!", "ok");
        closeEditModal();
        if(currentMode === "mes") await carregarMes();
        else await carregarCadastro();

      }catch(e){
        editErr.textContent = "Erro de conex√£o.";
        editErr.style.display = "block";
      }finally{
        btnSalvarEdicao.disabled = false;
        btnSalvarEdicao.textContent = "üíæ Salvar";
      }
    }

    btnSalvarEdicao.addEventListener("click", salvarEdicao);

    // ====== FILTROS / TABELA ======
    function buildSchoolOptions(rows){
      const schools = Array.from(new Set(rows.map(r => (r.escola||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      const cur = filtroEscola.value;
      filtroEscola.innerHTML = `<option value="">Todas</option>` + schools.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
      if(schools.includes(cur)) filtroEscola.value = cur;
    }

    function applyFiltersAndRender(){
      const sch = (filtroEscola.value || "").trim().toLowerCase();
      const q = (pesquisa.value || "").trim().toLowerCase();

      const rows = lastRows.filter(r => {
        const schoolOk = !sch || (String(r.escola||"").toLowerCase() === sch);
        const txt = (String(r.nome||"") + " " + String(r.matricula||"")).toLowerCase();
        const qOk = !q || txt.includes(q);
        return schoolOk && qOk;
      });

      renderTable(rows);
      renderKPIs(rows);
    }

    function renderKPIs(rows){
      kpiTotalFunc.textContent = String(rows.length);

      let comFolha = 0;
      let sumFaltas = 0;
      let sumHE = 0;

      for(const r of rows){
        const faltas = Number(r.faltas ?? 0);
        const he = Number(r.horas_extras ?? 0);
        const obs = String(r.observacoes ?? "").trim();
        const comAt = Number(r.falta_com_atestado ?? 0);

        const has = (faltas > 0) || (he > 0) || (comAt > 0) || (obs.length > 0);
        if(has) comFolha++;

        if(!Number.isNaN(faltas)) sumFaltas += faltas;
        if(!Number.isNaN(he)) sumHE += he;
      }

      kpiComFolha.textContent = String(comFolha);
      kpiFaltas.textContent = String(sumFaltas);
      kpiHE.textContent = String(sumHE);
    }

    function renderTable(rows){
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="11" class="hint">Nenhum registro encontrado.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const faltas = (r.faltas ?? "");
        const comAt = (r.falta_com_atestado ?? "");
        const he = (r.horas_extras ?? "");
        const obs = (r.observacoes ?? "");

        return `
          <tr>
            <td>${escapeHtml(r.escola||"")}</td>
            <td><b>${escapeHtml(r.matricula||"")}</b></td>
            <td>${escapeHtml(r.nome||"")}</td>
            <td>${escapeHtml(r.funcao||"")}</td>
            <td>${escapeHtml(r.vinculo||"")}</td>
            <td>${escapeHtml(r.carga||"")}</td>
            <td>${escapeHtml(faltas)}</td>
            <td>${escapeHtml(comAt)}</td>
            <td>${escapeHtml(he)}</td>
            <td>${escapeHtml(obs)}</td>
            <td><button class="btn" type="button" data-edit="${escapeHtml(r.matricula||"")}">‚úèÔ∏è Editar</button></td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const mat = btn.getAttribute("data-edit");
          const row = lastRows.find(x => String(x.matricula) === String(mat));
          if(row) openEditModal(row);
        });
      });
    }

    filtroEscola.addEventListener("change", applyFiltersAndRender);
    pesquisa.addEventListener("input", applyFiltersAndRender);

    // ====== CARREGAR CADASTRO ======
    async function carregarCadastro(){
      if(!ensureLogged()) return;
      currentMode = "cadastro";

      tableTitle.textContent = "Cadastro de Funcion√°rios";
      tableSubtitle.textContent = "Lista completa (cadastro fixo)";

      btnCarregarCadastro.disabled = true;
      btnCarregarCadastro.textContent = "Carregando...";

      try{
        const r = await fetch(API_CADASTRO, { headers: authHeaders() });
        const j = await r.json().catch(() => ({}));
        if(!r.ok || !j.ok){
          showMsg("‚ùå " + (j.error || "Falha ao carregar cadastro."), "err");
          return;
        }

        lastRows = (j.funcionarios || []).map(f => ({
          escola: f.escola || "",
          matricula: f.matricula || "",
          nome: f.nome || "",
          funcao: f.funcao || "",
          vinculo: f.vinculo || "",
          carga: f.carga || "",
          faltas: null,
          falta_com_atestado: null,
          horas_extras: null,
          observacoes: null,
          periodo: ""
        }));

        buildSchoolOptions(lastRows);
        applyFiltersAndRender();

      }catch(e){
        showMsg("‚ùå Erro de conex√£o ao carregar cadastro.", "err");
      }finally{
        btnCarregarCadastro.disabled = false;
        btnCarregarCadastro.textContent = "üë• Cadastro";
      }
    }

    // ====== CARREGAR M√äS ======
    async function carregarMes(){
      if(!ensureLogged()) return;
      currentMode = "mes";

      if(!periodo.value) periodo.value = defaultPeriodo();
      currentPeriodo = periodo.value;

      tableTitle.textContent = "Relat√≥rio do M√™s";
      tableSubtitle.textContent = "Per√≠odo: " + currentPeriodo;

      btnCarregarMes.disabled = true;
      btnCarregarMes.textContent = "Carregando...";

      try{
        const url = API_MES + "?periodo=" + encodeURIComponent(currentPeriodo);
        const r = await fetch(url, { headers: authHeaders() });
        const j = await r.json().catch(() => ({}));
        if(!r.ok || !j.ok){
          showMsg("‚ùå " + (j.error || "Falha ao carregar m√™s."), "err");
          return;
        }

        lastRows = (j.registros || []).map(x => ({
          escola: x.escola || "",
          matricula: x.matricula || "",
          nome: x.nome || "",
          funcao: x.funcao || "",
          vinculo: x.vinculo || "",
          carga: x.carga || "",
          periodo: x.periodo || currentPeriodo,
          faltas: (x.faltas ?? null),
          falta_com_atestado: (x.falta_com_atestado ?? null),
          horas_extras: (x.horas_extras ?? null),
          observacoes: (x.observacoes ?? null)
        }));

        buildSchoolOptions(lastRows);
        applyFiltersAndRender();
        showMsg("‚úÖ M√™s carregado com sucesso.", "ok");

      }catch(e){
        showMsg("‚ùå Erro de conex√£o ao carregar m√™s.", "err");
      }finally{
        btnCarregarMes.disabled = false;
        btnCarregarMes.textContent = "üìÖ Carregar M√™s";
      }
    }

    btnCarregarMes.addEventListener("click", carregarMes);
    btnCarregarCadastro.addEventListener("click", carregarCadastro);

    // ====== PDF PROFISSIONAL - PREFEITURA ======
    btnPDF.addEventListener("click", gerarPDFPrefeitura);

    function gerarPDFPrefeitura(){
      if(!ensureLogged()) return;

      if(currentMode !== "mes"){
        showMsg("Carregue um m√™s (üìÖ Carregar M√™s) antes de gerar o PDF.", "err");
        return;
      }

      if(!lastRows || !lastRows.length){
        showMsg("Nenhum dado para gerar PDF.", "err");
        return;
      }

      const p = (currentPeriodo || "");
      const now = new Date();
      const dt = now.toLocaleString("pt-BR");

      if(pdfPeriodoTxt) pdfPeriodoTxt.textContent = `Per√≠odo: ${p}`;
      if(pdfEmitidoEm) pdfEmitidoEm.textContent = `Emitido em: ${dt}`;

      let totalFaltas = 0;
      let totalComAt = 0;
      let totalHE = 0;

      for(const r of lastRows){
        totalFaltas += Number(r.faltas || 0);
        totalComAt += Number(r.falta_com_atestado || 0);
        totalHE += Number(r.horas_extras || 0);
      }

      if(pdfTotalsBox){
        pdfTotalsBox.innerHTML = `
          <b>Resumo do Per√≠odo</b><br>
          Total de funcion√°rios: ${lastRows.length} &nbsp;‚Ä¢&nbsp;
          Total de faltas: ${totalFaltas} &nbsp;‚Ä¢&nbsp;
          Total com atestado: ${totalComAt} &nbsp;‚Ä¢&nbsp;
          Total HE: ${totalHE}
        `;
      }

      if(printArea) printArea.style.display = "block";
      window.print();
      if(printArea) printArea.style.display = "none";
    }

    // ====== SAIR ======
    btnSair.addEventListener("click", () => {
      token = "";
      localStorage.removeItem("semec_admin_token");
      ensureLogged();
      tbody.innerHTML = `<tr><td colspan="11" class="hint">Deslogado. Fa√ßa login novamente.</td></tr>`;
      showMsg("üö™ Voc√™ saiu do Admin.", "warn");
    });

    // ====== INIT ======
    (function init(){
      periodo.value = defaultPeriodo();
      checkApi();
      setInterval(checkApi, 20000);

      if(!token){
        ensureLogged();
        adminPass.focus();
      }else{
        ensureLogged();
        carregarMes().catch(()=>{});
      }
    })();
  </script>

  <!--
    ‚úÖ COMO COLOCAR LOGO DE VERDADE:
    1) Coloque os arquivos dentro de /public (ex: public/logo_prefeitura.png e public/logo_semec.png)
    2) Troque:
         <div class="pdf-left">LOGO...</div>
       por:
         <div class="pdf-left" style="border:none;">
           <img src="logo_prefeitura.png" style="max-width:120px; max-height:60px;">
         </div>
       e fa√ßa o mesmo na .pdf-right
  -->
</body>
</html>

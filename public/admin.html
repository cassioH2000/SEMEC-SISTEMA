<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADM - SEMEC</title>
  <style>
    :root{
      --primary:#1f2d3d;
      --info:#2980b9;
      --success:#27ae60;
      --danger:#e74c3c;
      --bg:#f4f7f6;
      --border:#e6eaee;
      --muted:#6b7a80;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,system-ui,Arial;background:var(--bg);color:#122}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;color:var(--primary);font-size:18px}
    .sub{margin-top:6px;color:var(--muted);font-weight:800;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase}
    input{
      padding:10px;border:1px solid #dfe6ee;border-radius:10px;font-size:14px;outline:none;background:#fff;
    }
    input:focus{border-color:var(--info)}
    button{
      border:none;border-radius:10px;padding:10px 12px;font-weight:900;
      cursor:pointer;color:#fff
    }
    .btn-info{background:var(--info)}
    .btn-success{background:var(--success)}
    .btn-danger{background:var(--danger)}
    .btn-ghost{background:#eef2f6;color:#223;border:1px solid var(--border)}
    .muted{color:var(--muted);font-weight:800;font-size:12px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#f6f8fa;font-size:11px;font-weight:900}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hidden{display:none !important}
    table{width:100%;border-collapse:collapse}
    th{background:var(--primary);color:#fff;text-align:left;padding:10px;font-size:12px;white-space:nowrap}
    td{padding:9px;border-bottom:1px solid #edf0f3;font-size:13px;vertical-align:top}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
    @media(max-width:980px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .kpi{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .kpi .t{font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase}
    .kpi .v{font-size:18px;font-weight:1000;margin-top:3px;color:#111}
    .sep{border:none;border-top:1px solid var(--border);margin:12px 0}
    .warn{color:#8a4b00;background:#fff3e1;border:1px solid #ffe2b6;padding:10px;border-radius:12px;font-weight:900;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="top">
      <div>
        <h1>ADM – SEMEC</h1>
        <div class="sub">Acesso restrito • Balanços e consultas</div>
      </div>
      <div class="pill">URL: <span class="mono" id="baseUrl"></span></div>
    </div>

    <hr class="sep" />

    <div class="row">
      <div style="min-width:260px;flex:1">
        <label>Senha do ADM</label><br>
        <input id="senha" type="password" placeholder="Digite a senha" style="width:100%" />
        <div class="muted" style="margin-top:6px">Senha vem do Render: ADMIN_PASSWORD</div>
      </div>
      <button class="btn-success" onclick="loginADM()">Entrar</button>
    </div>

    <div id="loginMsg" class="warn hidden" style="margin-top:12px"></div>
  </div>

  <!-- PAINEL -->
  <div class="card hidden" id="panelCard">
    <div class="top">
      <div>
        <h1>Painel do Administrador</h1>
        <div class="sub">Balanço geral • Por escola • Por matrícula</div>
      </div>
      <div class="row">
        <button class="btn-ghost" onclick="sair()">Sair</button>
        <button class="btn-info" onclick="atualizarTudo()">Atualizar</button>
      </div>
    </div>

    <hr class="sep" />

    <!-- FILTROS -->
    <div class="row">
      <div>
        <label>Período</label><br/>
        <input id="fPeriod" type="month" />
      </div>
      <div>
        <label>Pesquisar (tabela)</label><br/>
        <input id="q" placeholder="nome, matrícula, escola, obs..." style="min-width:320px" />
      </div>
      <div class="row" style="margin-left:auto">
        <button class="btn-danger" onclick="pdfBalancoGeral()">PDF Balanço Geral</button>
      </div>
    </div>

    <hr class="sep" />

<div class="top">
  <div>
    <div class="pill">Relatório Geral (todas as escolas juntas)</div>
    <div class="sub">1 linha por funcionário (consolidado por matrícula)</div>
  </div>
  <div class="row">
    <button class="btn-info" onclick="carregarRelatorioGeral()">Carregar</button>
    <button class="btn-danger" onclick="pdfRelatorioGeral()">PDF Relatório Geral</button>
    <button class="btn-info" onclick="csvRelatorioGeral()">CSV Relatório Geral</button>
  </div>
</div>

<div style="overflow:auto;margin-top:10px">
  <table>
    <thead>
      <tr>
        <th>Matrícula</th>
        <th>Nome</th>
        <th>Função</th>
        <th>Vínculo</th>
        <th>Carga</th>
        <th>Escolas</th>
        <th>HE</th>
        <th>Falta A</th>
        <th>Falta S</th>
        <th>Envios</th>
        <th>Obs (consolidada)</th>
      </tr>
    </thead>
    <tbody id="tbodyRelGeral"></tbody>
  </table>
</div>

<div class="muted" style="margin-top:8px">
  Funcionários no relatório: <span id="countRelGeral">0</span>
</div>

    <!-- BALANÇO GERAL -->
    <div class="kpis">
      <div class="kpi"><div class="t">Registros</div><div class="v" id="kReg">0</div></div>
      <div class="kpi"><div class="t">Horas extras</div><div class="v" id="kHE">0</div></div>
      <div class="kpi"><div class="t">Faltas c/ atestado</div><div class="v" id="kFA">0</div></div>
      <div class="kpi"><div class="t">Faltas s/ atestado</div><div class="v" id="kFS">0</div></div>
    </div>
    <div class="muted" style="margin-top:8px"><b>Total faltas:</b> <span id="kTot">0</span></div>

    <hr class="sep" />

    <!-- POR ESCOLA -->
    <div class="top">
      <div>
        <div class="pill">Balanço por escola</div>
        <div class="sub">Clique em uma escola para filtrar a tabela abaixo</div>
      </div>
      <div class="row">
        <button class="btn-info" onclick="limparFiltroEscola()">Ver todas</button>
        <button class="btn-danger" onclick="pdfBalancoEscolas()">PDF Por Escola</button>
      </div>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Escola</th>
            <th>Registros</th>
            <th>Horas</th>
            <th>Falta A</th>
            <th>Falta S</th>
            <th>Total Faltas</th>
          </tr>
        </thead>
        <tbody id="tbodyEscolas"></tbody>
      </table>
    </div>

    <hr class="sep" />

    <!-- POR MATRÍCULA -->
    <div class="row">
      <div style="min-width:220px">
        <label>Resumo por matrícula</label><br/>
        <input id="mat" class="mono" placeholder="Ex: 110" />
      </div>
      <button class="btn-success" onclick="buscarResumoMatricula()">Buscar resumo</button>
      <button class="btn-danger" onclick="pdfResumoMatricula()">PDF matrícula</button>
    </div>

    <div id="boxResumo" class="card hidden" style="margin-top:12px;border-style:dashed">
      <div class="pill">Matrícula: <span class="mono" id="rMat"></span></div>
      <div style="margin-top:10px;font-weight:1000;font-size:16px" id="rNome"></div>
      <div class="muted" id="rMeta"></div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><div class="t">Horas extras</div><div class="v" id="rHE">0</div></div>
        <div class="kpi"><div class="t">Faltas c/ atestado</div><div class="v" id="rFA">0</div></div>
        <div class="kpi"><div class="t">Faltas s/ atestado</div><div class="v" id="rFS">0</div></div>
        <div class="kpi"><div class="t">Total faltas</div><div class="v" id="rTot">0</div></div>
      </div>
    </div>

    <hr class="sep" />

    <!-- TABELA REGISTROS -->
    <div class="top">
      <div>
        <div class="pill">Registros</div>
        <div class="sub">Filtrados por período, busca e (opcional) escola selecionada</div>
      </div>
      <div class="row">
        <button class="btn-info" onclick="exportarCSV()">Exportar CSV (tabela)</button>
      </div>
    </div>

    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Escola</th>
            <th>Período</th>
            <th>Matrícula</th>
            <th>Nome</th>
            <th>Função</th>
            <th>HE</th>
            <th>Falta A</th>
            <th>Falta S</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:10px">
      Mostrando <span id="count">0</span> registro(s).
      <span id="escolaAtiva" class="pill hidden" style="margin-left:8px"></span>
    </div>
  </div>

</div>

<script>
  const TOKEN_KEY = "SEMEC_ADM_OK_V1";
  document.getElementById("baseUrl").textContent = location.origin;

  let cache = [];
  let resumoCache = null;
  let escolaFiltro = null; // escola clicada

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }
  function toNum(n){ const x = Number(n); return Number.isFinite(x) ? x : 0; }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function periodoAtual(){
    const p = (document.getElementById("fPeriod").value||"").trim();
    return p || null;
  }

  async function loginADM(){
    const senha = document.getElementById("senha").value;
    const msg = document.getElementById("loginMsg");
    hide(msg);

    if(!senha){
      msg.textContent = "Digite a senha.";
      show(msg);
      return;
    }

    const resp = await fetch("/api/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ senha })
    });

    if(!resp.ok){
      msg.textContent = "Senha inválida.";
      show(msg);
      return;
    }

    const data = await resp.json();
    if(data.ok){
      localStorage.setItem(TOKEN_KEY, "1");
      abrirPainel();
    }else{
      msg.textContent = "Senha inválida.";
      show(msg);
    }
  }

  function abrirPainel(){
    hide(document.getElementById("loginCard"));
    show(document.getElementById("panelCard"));
    atualizarTudo();
  }

  function sair(){
    localStorage.removeItem(TOKEN_KEY);
    location.reload();
  }

  function setEscolaFiltro(nome){
    escolaFiltro = nome;
    const tag = document.getElementById("escolaAtiva");
    tag.textContent = "Escola: " + nome;
    show(tag);
    renderTabela();
  }

  function limparFiltroEscola(){
    escolaFiltro = null;
    hide(document.getElementById("escolaAtiva"));
    renderTabela();
  }

  async function atualizarTudo(){
    await Promise.all([atualizarBalancoGeral(), atualizarEscolas(), atualizarRegistros()]);
  }

  async function atualizarBalancoGeral(){
    const p = periodoAtual();
    const url = p ? `/api/balanco/geral?periodo=${encodeURIComponent(p)}` : `/api/balanco/geral`;
    const resp = await fetch(url);
    if(!resp.ok){ alert("Falha ao obter balanço geral"); return; }
    const b = await resp.json();

    document.getElementById("kReg").textContent = b.registros ?? 0;
    document.getElementById("kHE").textContent  = b.horas ?? 0;
    document.getElementById("kFA").textContent  = b.falta_atestado ?? 0;
    document.getElementById("kFS").textContent  = b.falta_sem_atestado ?? 0;
    document.getElementById("kTot").textContent = b.total_faltas ?? ((b.falta_atestado||0)+(b.falta_sem_atestado||0));
  }

  async function atualizarEscolas(){
    const p = periodoAtual();
    const url = p ? `/api/balanco/escolas?periodo=${encodeURIComponent(p)}` : `/api/balanco/escolas`;
    const resp = await fetch(url);
    if(!resp.ok){ alert("Falha ao obter balanço por escola"); return; }
    const data = await resp.json();

    const tbody = document.getElementById("tbodyEscolas");
    const rows = (data.escolas || []).map(e=>{
      const total = (toNum(e.falta_atestado) + toNum(e.falta_sem_atestado));
      const escola = e.escola || "(sem escola)";
      return `
        <tr style="cursor:pointer" onclick="setEscolaFiltro('${escapeHtml(escola).replaceAll("'","&#039;")}')">
          <td><b>${escapeHtml(escola)}</b></td>
          <td>${toNum(e.registros)}</td>
          <td>${toNum(e.horas)}</td>
          <td>${toNum(e.falta_atestado)}</td>
          <td>${toNum(e.falta_sem_atestado)}</td>
          <td><b>${total}</b></td>
        </tr>
      `;
    }).join("");

    tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Nenhum dado ainda.</td></tr>`;
  }

  async function atualizarRegistros(){
    // puxa todos (com período no backend se quiser, mas aqui filtramos na tela)
    const resp = await fetch("/api/registros");
    if(!resp.ok){ alert("Não foi possível obter registros"); return; }
    cache = await resp.json();
    renderTabela();
  }

  function filtradosTabela(){
    const p = (document.getElementById("fPeriod").value||"").trim();
    const q = (document.getElementById("q").value||"").trim().toLowerCase();

    return cache.filter(r=>{
      const okP = !p || String(r.periodo||"") === p;
      const okE = !escolaFiltro || String(r.escola||"(sem escola)") === escolaFiltro;
      const hay = `${r.id} ${r.escola} ${r.periodo} ${r.matricula} ${r.nome} ${r.funcao} ${r.obs}`.toLowerCase();
      const okQ = !q || hay.includes(q);
      return okP && okE && okQ;
    });
  }

  function renderTabela(){
    const list = filtradosTabela();
    document.getElementById("tbody").innerHTML = list.map(r=>`
      <tr>
        <td class="mono">${escapeHtml(r.id)}</td>
        <td>${escapeHtml(r.escola || "(sem escola)")}</td>
        <td class="mono">${escapeHtml(r.periodo||"")}</td>
        <td class="mono">${escapeHtml(r.matricula||"")}</td>
        <td>${escapeHtml(r.nome||"")}</td>
        <td>${escapeHtml(r.funcao||"")}</td>
        <td>${toNum(r.horas)}</td>
        <td>${toNum(r.falta_atestado)}</td>
        <td>${toNum(r.falta_sem_atestado)}</td>
        <td>${escapeHtml(r.obs||"").replace(/\n/g,"<br>")}</td>
      </tr>
    `).join("");

    document.getElementById("count").textContent = String(list.length);
  }

  document.getElementById("fPeriod").addEventListener("input", ()=>atualizarTudo());
  document.getElementById("q").addEventListener("input", renderTabela);

  async function buscarResumoMatricula(){
    const mat = (document.getElementById("mat").value||"").trim();
    if(!mat){ alert("Digite a matrícula."); return; }

    const resp = await fetch(`/api/resumo/${encodeURIComponent(mat)}`);
    if(!resp.ok){ alert("Não foi possível obter o resumo."); return; }
    const data = await resp.json();
    resumoCache = data;

    show(document.getElementById("boxResumo"));
    document.getElementById("rMat").textContent = mat;
    document.getElementById("rNome").textContent = data.nome || "(sem nome)";
    document.getElementById("rMeta").textContent =
      [data.funcao ? `Função: ${data.funcao}` : null,
       data.vinculo ? `Vínculo: ${data.vinculo}` : null,
       data.carga ? `Carga: ${data.carga}` : null].filter(Boolean).join(" • ") || "—";

    const he = toNum(data.horas);
    const fa = toNum(data.falta_atestado);
    const fs = toNum(data.falta_sem_atestado);

    document.getElementById("rHE").textContent = he;
    document.getElementById("rFA").textContent = fa;
    document.getElementById("rFS").textContent = fs;
    document.getElementById("rTot").textContent = fa + fs;
  }

  function exportarCSV(){
    const list = filtradosTabela();
    if(list.length === 0){ alert("Nada para exportar."); return; }

    let csv = "id;escola;periodo;matricula;nome;funcao;horas;falta_atestado;falta_sem_atestado;obs\n";
    list.forEach(r=>{
      const obs = String(r.obs||"").replace(/\n/g," ").replaceAll(";", ",");
      csv += `${r.id};${r.escola||""};${r.periodo||""};${r.matricula||""};${r.nome||""};${r.funcao||""};${toNum(r.horas)};${toNum(r.falta_atestado)};${toNum(r.falta_sem_atestado)};${obs}\n`;
    });

    const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "registros_semec.csv";
    a.click();
  }

  // ===== PDF (impressão) =====
  function cssPDF(){
    return `
    <style>
      @page{size:A4;margin:12mm;}
      body{font-family:Arial;color:#111}
      h1{font-size:16px;margin:0}
      .sub{font-size:11px;color:#555;margin-top:4px}
      .box{border:1px solid #ddd;border-radius:10px;padding:10px;margin-top:10px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border-bottom:1px solid #eee;padding:8px;font-size:11px;text-align:left;vertical-align:top}
      th{background:#1f2d3d;color:#fff}
      .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    </style>`;
  }
  function nowBR(){ return new Date().toLocaleString("pt-BR"); }
  function abrirJanelaPDF(html){
    const w = window.open("", "_blank");
    w.document.open(); w.document.write(html); w.document.close();
    w.onload = ()=>{ w.focus(); w.print(); };
  }

  async function pdfBalancoGeral(){
    const p = periodoAtual();
    const url = p ? `/api/balanco/geral?periodo=${encodeURIComponent(p)}` : `/api/balanco/geral`;
    const r = await fetch(url);
    const b = await r.json();
    const periodoTxt = p || "Todos";

    const html = `
    <html><head><meta charset="utf-8"/><title>Balanço Geral</title>${cssPDF()}</head>
    <body>
      <h1>Balanço Geral</h1>
      <div class="sub">Período: <span class="mono">${periodoTxt}</span> • Gerado em: <span class="mono">${nowBR()}</span></div>
      <div class="box">
        <table>
          <tr><th>Registros</th><td>${b.registros||0}</td></tr>
          <tr><th>Horas extras</th><td>${b.horas||0}</td></tr>
          <tr><th>Faltas c/ atestado</th><td>${b.falta_atestado||0}</td></tr>
          <tr><th>Faltas s/ atestado</th><td>${b.falta_sem_atestado||0}</td></tr>
          <tr><th>Total faltas</th><td><b>${b.total_faltas||0}</b></td></tr>
        </table>
      </div>
    </body></html>`;
    abrirJanelaPDF(html);
  }

  async function pdfBalancoEscolas(){
    const p = periodoAtual();
    const url = p ? `/api/balanco/escolas?periodo=${encodeURIComponent(p)}` : `/api/balanco/escolas`;
    const r = await fetch(url);
    const data = await r.json();
    const periodoTxt = p || "Todos";

    const rows = (data.escolas||[]).map(e=>{
      const tot = toNum(e.falta_atestado)+toNum(e.falta_sem_atestado);
      return `<tr>
        <td>${escapeHtml(e.escola||"(sem escola)")}</td>
        <td>${toNum(e.registros)}</td>
        <td>${toNum(e.horas)}</td>
        <td>${toNum(e.falta_atestado)}</td>
        <td>${toNum(e.falta_sem_atestado)}</td>
        <td><b>${tot}</b></td>
      </tr>`;
    }).join("");

    const html = `
    <html><head><meta charset="utf-8"/><title>Balanço por Escola</title>${cssPDF()}</head>
    <body>
      <h1>Balanço por Escola</h1>
      <div class="sub">Período: <span class="mono">${periodoTxt}</span> • Gerado em: <span class="mono">${nowBR()}</span></div>
      <div class="box">
        <table>
          <thead><tr>
            <th>Escola</th><th>Registros</th><th>Horas</th><th>Falta A</th><th>Falta S</th><th>Total</th>
          </tr></thead>
          <tbody>${rows || `<tr><td colspan="6">Sem dados</td></tr>`}</tbody>
        </table>
      </div>
    </body></html>`;
    abrirJanelaPDF(html);
  }

  function pdfResumoMatricula(){
    const mat = (document.getElementById("mat").value||"").trim();
    if(!mat || !resumoCache){ alert("Busque o resumo primeiro."); return; }
    const p = periodoAtual() || "Todos";
    const he = toNum(resumoCache.horas);
    const fa = toNum(resumoCache.falta_atestado);
    const fs = toNum(resumoCache.falta_sem_atestado);

    const html = `
    <html><head><meta charset="utf-8"/><title>Resumo ${mat}</title>${cssPDF()}</head>
    <body>
      <h1>Resumo por Matrícula</h1>
      <div class="sub">Matrícula: <span class="mono">${mat}</span> • Período: <span class="mono">${p}</span> • ${nowBR()}</div>
      <div class="box">
        <table>
          <tr><th>Nome</th><td>${escapeHtml(resumoCache.nome||"-")}</td></tr>
          <tr><th>Função</th><td>${escapeHtml(resumoCache.funcao||"-")}</td></tr>
          <tr><th>Vínculo</th><td>${escapeHtml(resumoCache.vinculo||"-")}</td></tr>
          <tr><th>Carga</th><td>${escapeHtml(resumoCache.carga||"-")}</td></tr>
          <tr><th>Horas extras</th><td>${he}</td></tr>
          <tr><th>Faltas c/ atestado</th><td>${fa}</td></tr>
          <tr><th>Faltas s/ atestado</th><td>${fs}</td></tr>
          <tr><th>Total faltas</th><td><b>${fa+fs}</b></td></tr>
        </table>
      </div>
    </body></html>`;
    abrirJanelaPDF(html);
  }

  // auto-login simples
  if(localStorage.getItem(TOKEN_KEY) === "1"){
    abrirPainel();
  }
  let relatorioGeralCache = [];

function periodoAtual(){
  const p = (document.getElementById("fPeriod").value||"").trim();
  return p || null;
}

async function carregarRelatorioGeral(){
  const p = periodoAtual();
  const url = p ? `/api/relatorio/geral?periodo=${encodeURIComponent(p)}` : `/api/relatorio/geral`;
  const resp = await fetch(url);
  if(!resp.ok){ alert("Não foi possível obter o Relatório Geral."); return; }

  const data = await resp.json();
  relatorioGeralCache = data.rows || [];
  renderRelatorioGeral();
}

function renderRelatorioGeral(){
  const tbody = document.getElementById("tbodyRelGeral");
  const rows = relatorioGeralCache.map(r=>{
    const he = Number(r.horas_extras||0);
    const fa = Number(r.falta_atestado||0);
    const fs = Number(r.falta_sem_atestado||0);

    return `
      <tr>
        <td class="mono">${escapeHtml(r.matricula||"")}</td>
        <td>${escapeHtml(r.nome||"")}</td>
        <td>${escapeHtml(r.funcao||"")}</td>
        <td>${escapeHtml(r.vinculo||"")}</td>
        <td>${escapeHtml(r.carga||"")}</td>
        <td>${escapeHtml(r.escolas||"")}</td>
        <td>${he}</td>
        <td>${fa}</td>
        <td>${fs}</td>
        <td>${Number(r.envios||0)}</td>
        <td>${escapeHtml(r.obs_consolidada||"").replace(/\n/g,"<br>")}</td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows || `<tr><td colspan="11" class="muted">Sem dados no período.</td></tr>`;
  document.getElementById("countRelGeral").textContent = String(relatorioGeralCache.length);
}

// CSV do Relatório Geral
function csvRelatorioGeral(){
  if(!relatorioGeralCache.length){ alert("Carregue o Relatório Geral primeiro."); return; }

  let csv = "matricula;nome;funcao;vinculo;carga;escolas;horas_extras;falta_atestado;falta_sem_atestado;envios;obs\n";
  relatorioGeralCache.forEach(r=>{
    const obs = String(r.obs_consolidada||"").replace(/\n/g," ").replaceAll(";", ",");
    csv += `${r.matricula||""};${r.nome||""};${r.funcao||""};${r.vinculo||""};${r.carga||""};${(r.escolas||"").replaceAll(";",",")};${r.horas_extras||0};${r.falta_atestado||0};${r.falta_sem_atestado||0};${r.envios||0};${obs}\n`;
  });

  const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "relatorio_geral_semec.csv";
  a.click();
}

// PDF do Relatório Geral (usa impressão)
function pdfRelatorioGeral(){
  if(!relatorioGeralCache.length){ alert("Carregue o Relatório Geral primeiro."); return; }

  const p = periodoAtual() || "Último mês (filtro)";
  const rows = relatorioGeralCache.map(r=>`
    <tr>
      <td class="mono">${escapeHtml(r.matricula||"")}</td>
      <td>${escapeHtml(r.nome||"")}</td>
      <td>${escapeHtml(r.funcao||"")}</td>
      <td>${escapeHtml(r.vinculo||"")}</td>
      <td>${escapeHtml(r.carga||"")}</td>
      <td>${escapeHtml(r.escolas||"")}</td>
      <td>${Number(r.horas_extras||0)}</td>
      <td>${Number(r.falta_atestado||0)}</td>
      <td>${Number(r.falta_sem_atestado||0)}</td>
      <td>${Number(r.envios||0)}</td>
      <td>${escapeHtml(r.obs_consolidada||"")}</td>
    </tr>
  `).join("");

  const html = `
  <html><head><meta charset="utf-8"/>
    <title>Relatório Geral</title>
    ${cssPDF()}
    <style>
      th,td{font-size:10px}
      table{table-layout:fixed}
      td{word-wrap:break-word}
    </style>
  </head>
  <body>
    <h1>Relatório Geral – Funcionários (todas as escolas juntas)</h1>
    <div class="sub">Período: <span class="mono">${p}</span> • Gerado em: <span class="mono">${nowBR()}</span></div>
    <div class="box">
      <table>
        <thead>
          <tr>
            <th>Matrícula</th><th>Nome</th><th>Função</th><th>Vínculo</th><th>Carga</th>
            <th>Escolas</th><th>HE</th><th>Falta A</th><th>Falta S</th><th>Envios</th><th>Obs</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="muted">Use “Salvar como PDF” na janela de impressão.</div>
  </body></html>`;

  abrirJanelaPDF(html);
}

</script>
</body>
</html>



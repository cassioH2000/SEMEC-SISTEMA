<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEMEC - Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f4f6f8; }
    header { background:#0b3a67; color:#fff; padding:16px; }
    header h1 { margin:0; font-size:18px; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

    .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,.06); margin-bottom:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size:12px; color:#444; display:block; margin-bottom:6px; }
    input, select, button, textarea {
      padding:10px; border:1px solid #d5dbe3; border-radius:8px; font-size:14px; outline:none;
    }
    input:focus, select:focus, textarea:focus { border-color:#0b3a67; }
    button { cursor:pointer; border:none; background:#0b3a67; color:#fff; font-weight:700; }
    button:hover { opacity:.92; }
    button.secondary { background:#64748b; }
    button.danger { background:#b91c1c; }
    .muted { color:#6b7280; font-size:12px; }

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:10px; text-align:left; vertical-align:top; }
    th { background:#f8fafc; position:sticky; top:0; z-index:1; }
    td small { display:block; color:#6b7280; }

    .pill { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
    .ok { background:#dcfce7; color:#166534; }
    .warn { background:#fef9c3; color:#854d0e; }
    .err { background:#fee2e2; color:#991b1b; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 900px) { .grid2 { grid-template-columns: 1fr; } }

    .w120{ width:120px; }
    .w160{ width:160px; }
    .w200{ width:200px; }
    .w260{ width:260px; }
    .w100{ width:100px; }
    .w80{ width:80px; }
    .w60{ width:60px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>SEMEC - ADMIN (Folha)</h1>
      <div class="muted">Editar: faltas, faltas com atestado, horas extras e observações.</div>
    </div>
  </header>

  <div class="wrap">

    <div class="card" id="cardLogin">
      <div class="row">
        <div>
          <label>Senha do Admin</label>
          <input id="adminPass" class="w260" type="password" placeholder="Digite a senha (ex: Semec2026)"/>
          <div class="muted">A senha é usada só para autenticar nas rotas /api/admin</div>
        </div>
        <div>
          <button onclick="loginAdmin()">Entrar</button>
        </div>
        <div id="loginStatus" class="muted"></div>
      </div>
    </div>

    <div class="card" id="cardPainel" style="display:none;">
      <div class="row">
        <div>
          <label>Mês</label>
          <input id="mes" class="w200" type="month"/>
          <div class="muted">Selecione o mês para carregar todos os funcionários</div>
        </div>
        <div>
          <button onclick="carregarMes()">Carregar mês</button>
        </div>
        <div>
          <button class="secondary" onclick="salvarTudo()">Salvar tudo</button>
        </div>
        <div class="right" style="flex:1;">
          <span id="totalInfo" class="muted"></span>
        </div>
      </div>
    </div>

    <div class="card" id="cardTabela" style="display:none;">
      <div style="overflow:auto; max-height:70vh;">
        <table>
          <thead>
            <tr>
              <th class="w80">Matrícula</th>
              <th>Nome</th>
              <th class="w200">Função</th>
              <th class="w100">Faltas</th>
              <th class="w160">Faltas c/ atestado</th>
              <th class="w120">Hora extra</th>
              <th>Observações</th>
              <th class="w120">Ação</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:10px;">
        Dica: você pode alterar os valores e clicar em <b>Salvar</b> na linha, ou <b>Salvar tudo</b>.
      </div>
    </div>

  </div>

<script>
  const API_BASE = "https://semec-sistema.onrender.com";
  let ADMIN_TOKEN = null;
  let dadosMes = []; // lista carregada do mês

  function setStatus(elId, text, type="") {
    const el = document.getElementById(elId);
    el.innerHTML = type
      ? `<span class="pill ${type}">${text}</span>`
      : text;
  }

  async function loginAdmin() {
    const pass = document.getElementById("adminPass").value.trim();
    if (!pass) {
      setStatus("loginStatus", "Digite a senha.", "warn");
      return;
    }

    setStatus("loginStatus", "Autenticando...", "warn");

    // Tenta login por token (recomendado)
    try {
      const res = await fetch(`${API_BASE}/api/admin/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pass })
      });

      const data = await res.json().catch(() => ({}));

      if (res.ok && data.token) {
        ADMIN_TOKEN = data.token;
        setStatus("loginStatus", "Login OK", "ok");
        document.getElementById("cardPainel").style.display = "block";
        document.getElementById("cardTabela").style.display = "block";
        return;
      }
    } catch (e) {}

    // Fallback: se seu server estiver usando senha por header (sem token)
    // A gente guarda a senha localmente e envia no header X-Admin-Password
    ADMIN_TOKEN = null;
    window.__ADMIN_PASSWORD_FALLBACK__ = pass;
    setStatus("loginStatus", "Login OK (modo senha no header)", "ok");
    document.getElementById("cardPainel").style.display = "block";
    document.getElementById("cardTabela").style.display = "block";
  }

  function adminHeaders(extra={}) {
    const h = { "Content-Type": "application/json", ...extra };

    if (ADMIN_TOKEN) {
      h["Authorization"] = `Bearer ${ADMIN_TOKEN}`;
    } else if (window.__ADMIN_PASSWORD_FALLBACK__) {
      h["X-Admin-Password"] = window.__ADMIN_PASSWORD_FALLBACK__;
    }
    return h;
  }
  function sanitizeNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function renderTabela(lista) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    lista.forEach((f, idx) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><b>${f.matricula}</b><small>${f.escola || "SEMEC"}</small></td>
        <td>${f.nome || ""}</td>
        <td>${f.funcao || ""}</td>
        <td><input class="w80" type="number" min="0" value="${sanitizeNum(f.faltas)}" data-i="${idx}" data-k="faltas"/></td>
        <td><input class="w120" type="number" min="0" value="${sanitizeNum(f.faltas_atestado)}" data-i="${idx}" data-k="faltas_atestado"/></td>
        <td><input class="w100" type="number" min="0" value="${sanitizeNum(f.horas_extras)}" data-i="${idx}" data-k="horas_extras"/></td>
        <td><input style="width:100%" type="text" value="${(f.obs || "").replaceAll('"', '&quot;')}" data-i="${idx}" data-k="obs"/></td>
        <td>
          <button class="secondary" onclick="salvarLinha(${idx})">Salvar</button>
          <div id="rowStatus${idx}" class="muted" style="margin-top:6px;"></div>
        </td>
      `;

      tbody.appendChild(tr);
    });

    document.querySelectorAll("input[data-i][data-k]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.getAttribute("data-i"));
        const k = e.target.getAttribute("data-k");
        let val = e.target.value;

        if (k !== "obs") val = sanitizeNum(val);
        dadosMes[i][k] = val;
      });
    });

    document.getElementById("totalInfo").innerText = `Total de funcionários: ${lista.length}`;
  }

  async function carregarMes() {
    const mes = document.getElementById("mes").value;
    if (!mes) {
      alert("Selecione o mês");
      return;
    }

    setStatus("totalInfo", "Carregando...", "");
    document.getElementById("tbody").innerHTML = `<tr><td colspan="8">Carregando...</td></tr>`;

    // Endpoint esperado:
    // GET /api/admin/folha?mes=2026-02
    // Deve retornar TODOS os funcionários no mês, mesmo zerados.
    const res = await fetch(`${API_BASE}/api/admin/folha?mes=${encodeURIComponent(mes)}`, {
      headers: adminHeaders()
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      document.getElementById("tbody").innerHTML = `<tr><td colspan="8">Erro ao carregar. Verifique server.js.</td></tr>`;
      setStatus("totalInfo", "Erro ao carregar", "");
      return;
    }

    dadosMes = data.funcionarios || [];
    renderTabela(dadosMes);
  }

  async function salvarLinha(index) {
    const mes = document.getElementById("mes").value;
    if (!mes) { alert("Selecione o mês"); return; }

    const f = dadosMes[index];
    const payload = {
      matricula: String(f.matricula),
      mes,
      faltas: sanitizeNum(f.faltas),
      faltas_atestado: sanitizeNum(f.faltas_atestado),
      horas_extras: sanitizeNum(f.horas_extras),
      obs: (f.obs || "")
    };

    const statusId = `rowStatus${index}`;
    setStatus(statusId, "Salvando...", "warn");

    const res = await fetch(`${API_BASE}/api/admin/folha/atualizar`, {
      method: "POST",
      headers: adminHeaders(),
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (res.ok && data.ok) {
      setStatus(statusId, "Salvo", "ok");
    } else {
      setStatus(statusId, "Erro", "err");
    }
  }

  async function salvarTudo() {
    const mes = document.getElementById("mes").value;
    if (!mes) { alert("Selecione o mês"); return; }
    if (!dadosMes.length) { alert("Carregue o mês primeiro"); return; }

    if (!confirm("Salvar tudo?")) return;

    // Salvar em lote (endpoint esperado):
    // POST /api/admin/folha/atualizar-lote
    const payload = {
      mes,
      itens: dadosMes.map(f => ({
        matricula: String(f.matricula),
        faltas: sanitizeNum(f.faltas),
        faltas_atestado: sanitizeNum(f.faltas_atestado),
        horas_extras: sanitizeNum(f.horas_extras),
        obs: (f.obs || "")
      }))
    };

    setStatus("totalInfo", "Salvando tudo...", "");

    const res = await fetch(`${API_BASE}/api/admin/folha/atualizar-lote`, {
      method: "POST",
      headers: adminHeaders(),
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (res.ok && data.ok) {
      setStatus("totalInfo", `Salvo! Total: ${dadosMes.length}`, "");
      alert("Tudo salvo com sucesso!");
    } else {
      setStatus("totalInfo", "Erro ao salvar tudo", "");
      alert("Erro ao salvar em lote. (Se seu server não tiver rota em lote, use salvar por linha.)");
    }
  }

  // Auto preenche mês atual (opcional)
  (function initMesAtual() {
    const now = new Date();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const yyyy = now.getFullYear();
    document.getElementById("mes").value = `${yyyy}-${mm}`;
  })();
</script>

</body>
</html>

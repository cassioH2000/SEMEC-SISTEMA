<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEMEC ‚Ä¢ Admin</title>

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#1f2d3d;
      --muted:#6b7280;
      --primary:#0d3b66;
      --ok:#27ae60;
      --warn:#d35400;
      --danger:#c0392b;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Arial,Helvetica,sans-serif; }
    .topbar{
      background:var(--primary); color:#fff;
      padding:16px 10px; box-shadow:0 6px 18px rgba(0,0,0,.15);
    }
    .wrap{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{height:44px; background:#fff; border-radius:10px; padding:6px}
    .brand b{display:block; font-size:16px}
    .brand span{display:block; font-size:12px; opacity:.9}
    .container{ max-width:1200px; margin:18px auto; padding:0 12px 50px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    h2{ margin:0 0 10px; font-size:16px; color:var(--primary); }
    label{ font-size:12px; color:var(--muted); font-weight:bold; display:block; margin-bottom:6px; }
    input, select, textarea{ width:100%; border:1px solid var(--border); border-radius:12px; padding:11px 12px; outline:none; }
    input:focus, select:focus, textarea:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.15); }
    textarea{ min-height:90px; resize:vertical; }

    .row{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px; }
    @media(max-width:1000px){ .row{grid-template-columns:1fr 1fr} }
    @media(max-width:620px){ .row{grid-template-columns:1fr} }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:none; border-radius:12px;
      padding:11px 14px; font-weight:bold; cursor:pointer;
      color:#fff; transition:.15s transform; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:active{ transform:scale(.99) }
    .btn.primary{ background:var(--primary) }
    .btn.ok{ background:var(--ok) }
    .btn.warn{ background:var(--warn) }
    .btn.danger{ background:var(--danger) }
    .btn.gray{ background:#4b5563 }

    .msg{ margin-top:12px; padding:12px; border-radius:12px; border:1px solid var(--border); background:#f8fafc; font-size:13px; }
    .msg.ok{ border-color:#86efac; background:#f0fdf4 }
    .msg.err{ border-color:#fecaca; background:#fef2f2 }

    table{
      width:100%; border-collapse:separate; border-spacing:0;
      border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff;
    }
    th, td{ font-size:12px; padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }
    th{ text-align:left; background:#f8fafc; color:#111827; }
    tr:last-child td{ border-bottom:none; }
    .muted{ color:var(--muted) }

    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; background:#eef2ff; color:#3730a3; font-weight:bold; }

    .flex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .right{ display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal{
      background:#fff; border:1px solid var(--border);
      border-radius:16px; width:min(760px, 100%); box-shadow:0 20px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal header{
      padding:14px 16px; background:#f8fafc; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal header b{ color:var(--primary) }
    .modal .content{ padding:14px 16px; }
    .mini{ font-size:12px; color:var(--muted); line-height:1.35; }

    .footer{ text-align:center; margin-top:16px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>

<div class="topbar">
  <div class="wrap">
    <div class="brand">
      <img src="logo.png" alt="SEMEC" onerror="this.style.display='none'">
      <div>
        <b>SEMEC ‚Ä¢ Painel Administrativo</b>
        <span>Relat√≥rios mensais ‚Ä¢ todas as escolas ‚Ä¢ edi√ß√£o e remo√ß√£o</span>
      </div>
    </div>
    <div class="flex">
      <span class="pill" id="statusAuth">N√£o autenticado</span>
      <button class="btn gray" id="btnLogout" style="display:none">Sair</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="grid">

    <div class="card" id="cardLogin">
      <h2>Login do Administrador</h2>
      <div class="row">
        <div style="grid-column: span 2;">
          <label>Senha do Admin</label>
          <input id="senha" type="password" placeholder="Digite a senha do admin" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button class="btn primary" id="btnLogin">Entrar</button>
        </div>
      </div>
      <div class="mini">Acesso restrito. A senha √© configurada no Render: <span class="pill">ADMIN_PASSWORD</span>.</div>
      <div id="msgLogin" class="msg" style="display:none"></div>
    </div>

    <div class="card" id="cardPainel" style="display:none">
      <h2>Filtros e A√ß√µes</h2>

      <div class="row">
        <div>
          <label>Per√≠odo (m√™s)</label>
          <input id="periodo" type="month">
        </div>

        <div>
          <label>Filtrar por Escola (opcional)</label>
          <select id="escolaFiltro">
            <option value="">Todas as escolas</option>
          </select>
        </div>

        <div>
          <label>Pesquisar (matr√≠cula ou nome)</label>
          <input id="pesquisa" placeholder="Ex: 396 ou Ana...">
        </div>

        <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="btnAtualizar">üîÑ Atualizar</button>
          <button class="btn warn" id="btnPdfMes">üìÑ PDF do M√™s</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="btnVerDetalhes">üìå Ver registros detalhados (por escola)</button>
        <button class="btn gray" id="btnVoltarResumo" style="display:none">‚¨ÖÔ∏è Voltar ao resumo</button>
      </div>

      <div id="msgPainel" class="msg" style="display:none"></div>
    </div>    <div class="card" id="cardBalanco" style="display:none">
      <h2>Balan√ßo Geral do M√™s (todas as escolas)</h2>
      <div class="row">
        <div>
          <label>Total de envios (registros)</label>
          <input id="kpiRegistros" disabled>
        </div>
        <div>
          <label>Horas extras (soma)</label>
          <input id="kpiHoras" disabled>
        </div>
        <div>
          <label>Faltas com atestado (soma)</label>
          <input id="kpiFA" disabled>
        </div>
        <div>
          <label>Faltas sem atestado (soma)</label>
          <input id="kpiFS" disabled>
        </div>
      </div>
      <div class="mini">Este balan√ßo considera todos os registros enviados no m√™s selecionado.</div>
    </div>

    <div class="card" id="cardTabela" style="display:none">
      <h2 id="tituloTabela">Relat√≥rio do M√™s (todos os funcion√°rios)</h2>

      <div class="mini" id="subtituloTabela"></div>
      <div style="height:10px"></div>

      <table>
        <thead>
          <tr>
            <th>Matr√≠cula</th>
            <th>Nome</th>
            <th>Fun√ß√£o</th>
            <th>V√≠nculo</th>
            <th>Carga</th>
            <th>Horas</th>
            <th>F. Atest.</th>
            <th>F. S/At.</th>
            <th>Escolas</th>
            <th>OBS</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="mini" style="margin-top:10px">
        ‚Ä¢ <b>Resumo</b>: mostra todos os funcion√°rios do cadastro mestre (<span class="pill">funcionarios</span>) e soma os envios no m√™s.<br>
        ‚Ä¢ Para <b>editar/apagar</b>, use ‚ÄúVer registros detalhados‚Äù.
      </div>
    </div>

  </div>

  <div class="footer">SEMEC ‚Ä¢ Wagner/BA ‚Ä¢ Admin 2026</div>
</div>

<!-- MODAL DETALHES (registros por escola) -->
<div class="modal-backdrop" id="modalBack">
  <div class="modal">
    <header>
      <b>Registros detalhados (editar/apagar)</b>
      <button class="btn danger" id="btnFecharModal" style="padding:8px 10px;border-radius:10px">Fechar</button>
    </header>
    <div class="content">
      <div class="mini" id="detalhesInfo"></div>
      <div style="height:10px"></div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Escola</th>
            <th>Matr√≠cula</th>
            <th>Nome</th>
            <th>Horas</th>
            <th>F. Atest.</th>
            <th>F. S/At.</th>
            <th>OBS</th>
            <th>Atualizado</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyDet"></tbody>
      </table>

      <div class="mini" style="margin-top:10px">
        ‚Ä¢ <b>Editar</b>: clique ‚ÄúA‚Äù e altere.<br>
        ‚Ä¢ <b>Apagar</b>: clique ‚ÄúB‚Äù e confirma.
      </div>
    </div>
  </div>
</div>

<script>
/* ====== 1) Estado/Auth ====== */
const LS_TOKEN = "semec_admin_token_v1";
let token = localStorage.getItem(LS_TOKEN) || "";
let modoDetalhes = false;

/* ====== 2) Elementos ====== */
const statusAuth = document.getElementById("statusAuth");
const btnLogout = document.getElementById("btnLogout");

const cardLogin = document.getElementById("cardLogin");
const cardPainel = document.getElementById("cardPainel");
const cardBalanco = document.getElementById("cardBalanco");
const cardTabela = document.getElementById("cardTabela");

const senhaEl = document.getElementById("senha");
const btnLogin = document.getElementById("btnLogin");
const msgLogin = document.getElementById("msgLogin");

const periodoEl = document.getElementById("periodo");
const escolaFiltroEl = document.getElementById("escolaFiltro");
const pesquisaEl = document.getElementById("pesquisa");
const btnAtualizar = document.getElementById("btnAtualizar");
const btnPdfMes = document.getElementById("btnPdfMes");
const btnVerDetalhes = document.getElementById("btnVerDetalhes");
const btnVoltarResumo = document.getElementById("btnVoltarResumo");
const msgPainel = document.getElementById("msgPainel");

const kpiRegistros = document.getElementById("kpiRegistros");
const kpiHoras = document.getElementById("kpiHoras");
const kpiFA = document.getElementById("kpiFA");
const kpiFS = document.getElementById("kpiFS");

const tituloTabela = document.getElementById("tituloTabela");
const subtituloTabela = document.getElementById("subtituloTabela");
const tbody = document.getElementById("tbody");

// modal detalhes
const modalBack = document.getElementById("modalBack");
const btnFecharModal = document.getElementById("btnFecharModal");
const detalhesInfo = document.getElementById("detalhesInfo");
const tbodyDet = document.getElementById("tbodyDet");

/* ====== 3) Util ====== */
function setMsg(el, text, type){
  el.style.display = "block";
  el.textContent = text;
  el.className = "msg " + (type || "");
}
function clearMsg(el){
  el.style.display = "none";
  el.textContent = "";
}
function nowMonthISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function authHeaders(){
  return token ? { "Authorization": "Bearer " + token } : {};
}
function moeda(n){ return String(n ?? 0); }

function updateAuthUI(){
  const ok = !!token;
  statusAuth.textContent = ok ? "Autenticado" : "N√£o autenticado";
  statusAuth.style.background = ok ? "#dcfce7" : "#fee2e2";
  statusAuth.style.color = ok ? "#166534" : "#991b1b";
  btnLogout.style.display = ok ? "inline-flex" : "none";

  cardLogin.style.display = ok ? "none" : "block";
  cardPainel.style.display = ok ? "block" : "none";
  cardBalanco.style.display = ok ? "block" : "none";
  cardTabela.style.display = ok ? "block" : "none";
}

/* ====== 4) Login/Logout ====== */
btnLogin.addEventListener("click", async ()=>{
  clearMsg(msgLogin);
  const senha = senhaEl.value || "";
  if(!senha){ setMsg(msgLogin, "Digite a senha.", "err"); return; }

  try{
    btnLogin.disabled = true;
    btnLogin.textContent = "Entrando...";

    const resp = await fetch("/api/login", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ senha })
    });
    const data = await resp.json().catch(()=> ({}));

    if(!resp.ok || !data.ok || !data.token){
      setMsg(msgLogin, "Senha inv√°lida ou servidor n√£o retornou token.", "err");
      btnLogin.disabled = false;
      btnLogin.textContent = "Entrar";
      return;
    }

    token = data.token;
    localStorage.setItem(LS_TOKEN, token);
    senhaEl.value = "";

    updateAuthUI();
    await atualizarTudo();

  }catch(e){
    setMsg(msgLogin, "Erro de rede ao logar.", "err");
  }finally{
    btnLogin.disabled = false;
    btnLogin.textContent = "Entrar";
  }
});

btnLogout.addEventListener("click", ()=>{
  token = "";
  localStorage.removeItem(LS_TOKEN);
  updateAuthUI();
});

/* ====== 5) Inicial ====== */
periodoEl.value = nowMonthISO();
updateAuthUI();/* ====== 6) Buscar resumo do m√™s (todos funcion√°rios) ====== */
let cacheRows = [];

async function fetchResumoMes(periodo){
  const resp = await fetch(`/api/admin/mes?periodo=${encodeURIComponent(periodo)}`);
  const data = await resp.json().catch(()=> ({}));
  if(!resp.ok || !data.ok) throw new Error("Falha ao carregar /api/admin/mes");
  return data.rows || [];
}

async function fetchBalanco(periodo){
  const resp = await fetch(`/api/admin/balanco?periodo=${encodeURIComponent(periodo)}`);
  const data = await resp.json().catch(()=> ({}));
  if(!resp.ok || !data.ok) throw new Error("Falha ao carregar /api/admin/balanco");
  return data;
}

function buildEscolaOptions(rows){
  const set = new Set();
  for(const r of rows){
    const escolas = String(r.escolas || "").split(",").map(x=>x.trim()).filter(Boolean);
    for(const e of escolas) set.add(e);
  }
  const arr = Array.from(set).sort((a,b)=>a.localeCompare(b));
  escolaFiltroEl.innerHTML = `<option value="">Todas as escolas</option>` + arr.map(e=>`<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("");
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function applyFilters(){
  const q = (pesquisaEl.value || "").trim().toLowerCase();
  const escola = (escolaFiltroEl.value || "").trim();

  return cacheRows.filter(r=>{
    const mat = String(r.matricula || "").toLowerCase();
    const nome = String(r.nome || "").toLowerCase();
    const escolas = String(r.escolas || "");
    const okQ = !q || mat.includes(q) || nome.includes(q);
    const okE = !escola || escolas.split(",").map(x=>x.trim()).includes(escola);
    return okQ && okE;
  });
}

function renderResumo(rows){
  tbody.innerHTML = "";
  const frag = document.createDocumentFragment();

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.matricula)}</td>
      <td><b>${escapeHtml(r.nome || "")}</b></td>
      <td>${escapeHtml(r.funcao || "")}</td>
      <td>${escapeHtml(r.vinculo || "")}</td>
      <td>${escapeHtml(r.carga || "")}</td>
      <td>${escapeHtml(r.horas ?? 0)}</td>
      <td>${escapeHtml(r.falta_atestado ?? 0)}</td>
      <td>${escapeHtml(r.falta_sem_atestado ?? 0)}</td>
      <td>${escapeHtml(r.escolas || "")}</td>
      <td>${escapeHtml(r.obs || "")}</td>
      <td>
        <button class="btn warn" style="padding:8px 10px;border-radius:10px" data-act="pdf1" data-m="${escapeHtml(r.matricula)}">üìÑ</button>
      </td>
    `;
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);

  tituloTabela.textContent = "Relat√≥rio do M√™s (todos os funcion√°rios)";
  subtituloTabela.textContent = `Total exibido: ${rows.length} funcion√°rio(s).`;
}

/* ====== 7) Detalhes por registros (editar/apagar) ====== */
async function fetchRegistrosDetalhados(periodo, escola){
  let url = `/api/admin/registros?periodo=${encodeURIComponent(periodo)}`;
  if(escola) url += `&escola=${encodeURIComponent(escola)}`;

  const resp = await fetch(url);
  const data = await resp.json().catch(()=> ({}));
  if(!resp.ok || !data.ok) throw new Error("Falha ao carregar /api/admin/registros");
  return data.rows || [];
}

function renderDetalhes(rows){
  tbodyDet.innerHTML = "";
  const frag = document.createDocumentFragment();

  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.id)}</td>
      <td>${escapeHtml(r.escola)}</td>
      <td>${escapeHtml(r.matricula)}</td>
      <td><b>${escapeHtml(r.nome || "")}</b></td>
      <td>${escapeHtml(r.horas ?? 0)}</td>
      <td>${escapeHtml(r.falta_atestado ?? 0)}</td>
      <td>${escapeHtml(r.falta_sem_atestado ?? 0)}</td>
      <td>${escapeHtml(r.obs || "")}</td>
      <td>${escapeHtml(r.updated_at || "")}</td>
      <td class="flex">
        <button class="btn primary" style="padding:8px 10px;border-radius:10px" data-act="edit" data-id="${escapeHtml(r.id)}">A</button>
        <button class="btn danger" style="padding:8px 10px;border-radius:10px" data-act="del" data-id="${escapeHtml(r.id)}">B</button>
      </td>
    `;
    frag.appendChild(tr);
  }

  tbodyDet.appendChild(frag);
}

btnFecharModal.addEventListener("click", ()=> modalBack.style.display = "none");

tbodyDet.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const act = btn.dataset.act;
  const id = btn.dataset.id;

  if(act === "del"){
    if(!confirm("Confirma apagar este registro?")) return;

    const resp = await fetch(`/api/registros/${encodeURIComponent(id)}`, {
      method: "DELETE",
      headers: { ...authHeaders() }
    });
    const data = await resp.json().catch(()=> ({}));

    if(!resp.ok || !data.ok){
      alert("Falha ao apagar. Verifique se est√° logado (token).");
      return;
    }
    alert("Apagado!");
    await abrirDetalhes();
    await atualizarTudo();
  }

  if(act === "edit"){
    const escola = prompt("Escola:", "");
    const periodo = prompt("Per√≠odo (YYYY-MM):", periodoEl.value);
    const horas = prompt("Horas (0-300):", "0");
    const fa = prompt("Falta com atestado (0-15):", "0");
    const fs = prompt("Falta sem atestado (0-15):", "0");
    const obs = prompt("OBS:", "");

    const payload = {
      escola: escola || "",
      periodo: periodo || periodoEl.value,
      horas: Number(horas||0),
      falta_atestado: Number(fa||0),
      falta_sem_atestado: Number(fs||0),
      obs: obs || ""
    };

    const resp = await fetch(`/api/registros/${encodeURIComponent(id)}`, {
      method: "PUT",
      headers: { "Content-Type":"application/json", ...authHeaders() },
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=> ({}));

    if(!resp.ok || !data.ok){
      alert("Falha ao editar. Verifique se est√° logado (token).");
      return;
    }
    alert("Editado!");
    await abrirDetalhes();
    await atualizarTudo();
  }
});

/* ====== 8) PDF (simples, via janela de impress√£o) ====== */
function abrirPdfHtml(html, titulo="Relat√≥rio"){
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(`
    <html><head><meta charset="utf-8"><title>${titulo}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;padding:18px}
      h1{font-size:16px;margin:0 0 10px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:8px;font-size:12px}
      th{background:#f3f4f6}
    </style>
    </head><body>${html}</body></html>
  `);
  w.document.close();
  w.focus();
  w.print();
}

btnPdfMes.addEventListener("click", ()=>{
  const periodo = periodoEl.value;
  const rows = applyFilters();

  const html = `
    <h1>SEMEC ‚Ä¢ Relat√≥rio do m√™s ${escapeHtml(periodo)}</h1>
    <div style="font-size:12px;color:#555;margin-bottom:10px">
      Total: ${rows.length} funcion√°rio(s) ‚Ä¢ Filtro escola: ${escapeHtml(escolaFiltroEl.value||"Todas")}
    </div>
    <table>
      <thead>
        <tr>
          <th>Matr√≠cula</th><th>Nome</th><th>Fun√ß√£o</th><th>V√≠nculo</th><th>Carga</th>
          <th>Horas</th><th>F. Atest.</th><th>F. S/At.</th><th>Escolas</th><th>OBS</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.matricula)}</td>
            <td>${escapeHtml(r.nome||"")}</td>
            <td>${escapeHtml(r.funcao||"")}</td>
            <td>${escapeHtml(r.vinculo||"")}</td>
            <td>${escapeHtml(r.carga||"")}</td>
            <td>${escapeHtml(r.horas??0)}</td>
            <td>${escapeHtml(r.falta_atestado??0)}</td>
            <td>${escapeHtml(r.falta_sem_atestado??0)}</td>
            <td>${escapeHtml(r.escolas||"")}</td>
            <td>${escapeHtml(r.obs||"")}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  abrirPdfHtml(html, `SEMEC_${periodo}`);
});

// PDF individual
tbody.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.act !== "pdf1") return;

  const mat = btn.dataset.m;
  const r = cacheRows.find(x => String(x.matricula) === String(mat));
  if(!r) return;

  const periodo = periodoEl.value;

  const html = `
    <h1>SEMEC ‚Ä¢ Resumo Individual ‚Ä¢ ${escapeHtml(periodo)}</h1>
    <div style="font-size:13px;margin-bottom:12px">
      <b>${escapeHtml(r.nome||"")}</b><br>
      Matr√≠cula: ${escapeHtml(r.matricula)}<br>
      Fun√ß√£o: ${escapeHtml(r.funcao||"")}<br>
      V√≠nculo: ${escapeHtml(r.vinculo||"")} ‚Ä¢ Carga: ${escapeHtml(r.carga||"")}<br>
      Escolas: ${escapeHtml(r.escolas||"")}
    </div>

    <table>
      <tr><th>Horas extras</th><td>${escapeHtml(r.horas??0)}</td></tr>
      <tr><th>Falta com atestado</th><td>${escapeHtml(r.falta_atestado??0)}</td></tr>
      <tr><th>Falta sem atestado</th><td>${escapeHtml(r.falta_sem_atestado??0)}</td></tr>
      <tr><th>OBS</th><td>${escapeHtml(r.obs||"")}</td></tr>
    </table>
  `;
  abrirPdfHtml(html, `SEMEC_${periodo}_${r.matricula}`);
});

/* ====== 9) Fluxo principal ====== */
async function atualizarTudo(){
  clearMsg(msgPainel);

  const periodo = periodoEl.value || nowMonthISO();

  try{
    // resumo
    cacheRows = await fetchResumoMes(periodo);
    buildEscolaOptions(cacheRows);
    renderResumo(applyFilters());

    // balan√ßo
    const bal = await fetchBalanco(periodo);
    kpiRegistros.value = bal.registros ?? 0;
    kpiHoras.value = bal.horas ?? 0;
    kpiFA.value = bal.falta_atestado ?? 0;
    kpiFS.value = bal.falta_sem_atestado ?? 0;

  }catch(e){
    setMsg(msgPainel, "Erro ao atualizar. Verifique o servidor e o per√≠odo.", "err");
  }
}

btnAtualizar.addEventListener("click", atualizarTudo);
pesquisaEl.addEventListener("input", ()=> renderResumo(applyFilters()));
escolaFiltroEl.addEventListener("change", ()=> renderResumo(applyFilters()));

async function abrirDetalhes(){
  const periodo = periodoEl.value || nowMonthISO();
  const escola = escolaFiltroEl.value || "";

  try{
    const rows = await fetchRegistrosDetalhados(periodo, escola);
    detalhesInfo.textContent = `Per√≠odo: ${periodo} ‚Ä¢ Escola: ${escola || "Todas (detalhes mostra tudo)" } ‚Ä¢ Total registros: ${rows.length}`;
    renderDetalhes(rows);
    modalBack.style.display = "flex";
  }catch(e){
    alert("Falha ao abrir detalhes.");
  }
}

btnVerDetalhes.addEventListener("click", abrirDetalhes);

// Se j√° tem token, carrega autom√°tico
if(token){
  atualizarTudo();
}
</script>
</body>
</html>

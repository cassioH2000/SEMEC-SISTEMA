<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEMEC ‚Ä¢ Folha de Ponto</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c162b;
      --text:#e5e7eb;
      --muted:#93a4bd;
      --line:rgba(255,255,255,0.08);
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,0.35);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1100px 700px at 20% 0%, #1e2a45 0%, var(--bg) 55%);
      min-height:100vh;
    }

    header{
      padding:18px 16px 10px;
    }

    .topbar{
      max-width:1100px;
      margin:0 auto;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 16px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:240px;
    }

    .logo{
      width:46px;height:46px;
      border-radius:14px;
      background: linear-gradient(145deg, rgba(37,99,235,0.95), rgba(34,197,94,0.75));
      display:grid;place-items:center;
      font-weight:900;
      letter-spacing:.5px;
      box-shadow: 0 14px 28px rgba(37,99,235,0.25);
      user-select:none;
    }

    .brand h1{
      margin:0;
      font-size:15px;
      line-height:1.1;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--warn);
      box-shadow:0 0 0 4px rgba(245,158,11,0.15);
    }
    .dot.ok{ background: var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,0.15); }
    .dot.bad{ background: var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,0.15); }

    main{ padding: 8px 16px 40px; }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.12fr 0.88fr;
      gap:14px;
    }
    @media (max-width:980px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,0.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .head h2{ margin:0; font-size:14px; }
    .head span{ color:var(--muted); font-size:12px; }

    .content{ padding:16px; }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.20);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder, textarea::placeholder{ color: rgba(147,164,189,0.75); }

    textarea{ min-height:110px; resize:vertical; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:700px){ .grid{ grid-template-columns:1fr; } }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      cursor:pointer;
      border:none;
      padding:12px 14px;
      border-radius:14px;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: 0 16px 34px rgba(37,99,235,0.25);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-width:170px;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.secondary{
      background: rgba(255,255,255,0.06);
      border:1px solid var(--line);
      color:var(--text);
      box-shadow:none;
      font-weight:700;
    }

    .msg{
      display:none;
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.18);
      font-size:13px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    .msg.ok{ display:block; color:#bbf7d0; border-color: rgba(34,197,94,0.25); background: rgba(34,197,94,0.10); }
    .msg.err{ display:block; color:#fecaca; border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.10); }

    .hint{ font-size:12px; color:var(--muted); }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--line);
      padding:2px 8px;
      border-radius:999px;
      color:var(--text);
    }

    table{
      width:100%;
      border-collapse:collapse;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      font-size:13px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      vertical-align:top;
    }
    th{
      background: rgba(255,255,255,0.05);
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }
    tr:last-child td{ border-bottom:none; }

    /* Modal senha */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.72);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,0.18);
    }
    .modal .mhead h3{ margin:0; font-size:14px; }
    .modal .mbody{ padding:16px; }
    .modal .mbody p{ margin:0 0 10px; color:var(--muted); font-size:13px; }
    .modal .mrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .modal .merr{ margin-top:10px; color:#fecaca; font-size:13px; display:none; }
  </style>
</head>

<body>
  <!-- MODAL SENHA -->
  <div class="overlay" id="lockOverlay">
    <div class="modal">
      <div class="mhead">
        <h3>üîí Acesso restrito</h3>
      </div>
      <div class="mbody">
        <p>Digite a senha para acessar a Folha.</p>
        <label for="senhaAcesso">Senha</label>
        <input id="senhaAcesso" type="password" placeholder="Digite a senha..." />
        <div class="mrow">
          <button class="btn" id="btnEntrar" type="button">‚úÖ Entrar</button>
        </div>
        <div class="merr" id="senhaErr">Senha inv√°lida.</div>
        <div class="hint" style="margin-top:10px;">Dica: a senha √© definida pela SEMEC.</div>
      </div>
    </div>
  </div>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo">SE</div>
        <div>
          <h1>SEMEC ‚Ä¢ Folha de Ponto</h1>
          <p>Atualiza automaticamente o cadastro no Admin</p>
        </div>
      </div>

      <div class="status">
        <div class="pill"><span class="dot" id="dotApi"></span><span>Servidor: <b id="apiStatus">verificando‚Ä¶</b></span></div>
        <div class="pill">Enviar: <span class="kbd">POST /api/folha/enviar</span></div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">

      <!-- FORM -->
      <section class="card">
        <div class="head">
          <h2>Preencher Folha</h2>
          <span>Busque por matr√≠cula ou nome</span>
        </div>
        <div class="content">

          <div class="grid">
            <div>
              <label for="periodo">M√™s/Ano</label>
              <input id="periodo" type="month" />
              <div class="hint" style="margin-top:6px;">Ex.: 2026-02</div>
            </div>

            <div>
              <label for="escola">Escola</label>
              <input id="escola" type="text" placeholder="Ex.: Escola X" />
            </div>

            <div>
              <label for="busca">Buscar (matr√≠cula ou nome)</label>
              <input id="busca" type="text" placeholder="Digite matr√≠cula ou 1¬™ letra do nome‚Ä¶" list="listaNomes" />
              <datalist id="listaNomes"></datalist>
              <div class="hint" style="margin-top:6px;">
                Digite <span class="kbd">396</span> ou <span class="kbd">A</span> e selecione.
              </div>
            </div>

            <div>
              <label for="matricula">Matr√≠cula</label>
              <input id="matricula" type="text" placeholder="Ex.: 396" />
            </div>

            <div>
              <label for="nome">Nome</label>
              <input id="nome" type="text" placeholder="Nome completo" />
            </div>

            <div>
              <label for="funcao">Fun√ß√£o</label>
              <input id="funcao" type="text" placeholder="Ex.: Professor" />
            </div>

            <div>
              <label for="vinculo">V√≠nculo</label>
              <input id="vinculo" type="text" placeholder="Ex.: Efetivo / Contrato" />
            </div>

            <div>
              <label for="carga">Carga Hor√°ria</label>
              <input id="carga" type="text" placeholder="Ex.: 20h / 40h" />
            </div>

            <div>
              <label for="horas_extras">Horas Extras</label>
              <input id="horas_extras" type="number" min="0" step="1" placeholder="0" />
            </div>

            <div>
              <label for="falta_com_atestado">Falta com atestado (0‚Äì15)</label>
              <input id="falta_com_atestado" type="number" min="0" max="15" step="1" placeholder="0" />
            </div>

            <div>
              <label for="falta_sem_atestado">Falta sem atestado (0‚Äì15)</label>
              <input id="falta_sem_atestado" type="number" min="0" max="15" step="1" placeholder="0" />
            </div>

            <div>
              <label for="total_faltas">Total de faltas (auto)</label>
              <input id="total_faltas" type="number" min="0" step="1" placeholder="0" disabled />
              <div class="hint" style="margin-top:6px;">Total = com atestado + sem atestado</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <label for="observacoes">Observa√ß√µes (separado)</label>
            <textarea id="observacoes" placeholder="Digite observa√ß√µes do m√™s‚Ä¶"></textarea>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn" id="btnEnviar" type="button">üì© Enviar para ADM</button>
            <button class="btn secondary" id="btnLimpar" type="button">üßπ Limpar</button>
            <span class="hint">Ap√≥s enviar, o funcion√°rio √© atualizado no Admin.</span>
          </div>

          <div class="msg" id="msgBox"></div>
        </div>
      </section>

      <!-- HIST√ìRICO LOCAL -->
      <section class="card">
        <div class="head">
          <h2>√öltimos envios (neste aparelho)</h2>
          <span>Hist√≥rico local</span>
        </div>
        <div class="content">
          <div class="row" style="margin-bottom:10px;">
            <button class="btn secondary" id="btnAtualizarLista" type="button">üîÑ Atualizar</button>
            <button class="btn secondary" id="btnLimparHistorico" type="button">üóëÔ∏è Limpar hist√≥rico</button>
          </div>

          <div class="hint" style="margin-bottom:10px;">
            Isto √© s√≥ confer√™ncia local. O que vale √© o que o servidor grava.
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Per√≠odo</th>
                  <th>Matr√≠cula</th>
                  <th>Nome</th>
                  <th>Faltas</th>
                  <th>HE</th>
                </tr>
              </thead>
              <tbody id="listaEnvios">
                <tr><td colspan="5" class="hint">Nenhum envio ainda.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="msg" id="msgList"></div>
        </div>
      </section>

    </div>
  </main>
  <script>
    // ======= CONFIG =======
    const SENHA_ACESSO = "semec2026";
    const API_HEALTH = "/api/health";
    const API_ENVIAR = "/api/folha/enviar";

    // ======= DOM =======
    const $ = (id) => document.getElementById(id);

    const lockOverlay = $("lockOverlay");
    const senhaAcesso = $("senhaAcesso");
    const btnEntrar = $("btnEntrar");
    const senhaErr = $("senhaErr");

    const dotApi = $("dotApi");
    const apiStatus = $("apiStatus");

    const periodo = $("periodo");
    const escola = $("escola");
    const busca = $("busca");
    const listaNomes = $("listaNomes");

    const matricula = $("matricula");
    const nome = $("nome");
    const funcao = $("funcao");
    const vinculo = $("vinculo");
    const carga = $("carga");

    const horas_extras = $("horas_extras");
    const falta_com_atestado = $("falta_com_atestado");
    const falta_sem_atestado = $("falta_sem_atestado");
    const total_faltas = $("total_faltas");
    const observacoes = $("observacoes");

    const btnEnviar = $("btnEnviar");
    const btnLimpar = $("btnLimpar");
    const msgBox = $("msgBox");

    const btnAtualizarLista = $("btnAtualizarLista");
    const btnLimparHistorico = $("btnLimparHistorico");
    const listaEnvios = $("listaEnvios");
    const msgList = $("msgList");

    // ======= FUNCION√ÅRIOS (EXEMPLOS PARA TESTE) =======
    // Voc√™ pode substituir depois pela lista completa.
    // Formato: "matricula": {nome, funcao, vinculo, carga}
    const FUNCIONARIOS = {
      "396": { nome: "Ademilson Jose de Souza", funcao: "Professor", vinculo: "", carga: "20h" },
      "275": { nome: "Ademilton Xavier da Silva", funcao: "Professor", vinculo: "", carga: "20h" },
      "1659": { nome: "Adriana Almeida Nobre", funcao: "Vice - Diretor Escolar", vinculo: "", carga: "" },
      "83": { nome: "Ailton Novaes dos Santos", funcao: "Motorista", vinculo: "", carga: "" },
      "560": { nome: "Alessandra Lima Rodrigues", funcao: "Professor", vinculo: "", carga: "20h" },
      "404": { nome: "Andre de Cassio Santos Araujo", funcao: "Professor", vinculo: "", carga: "20h" },
      "2008": { nome: "Cassio Henrique Alvez de Oliveira", funcao: "Assistente de Manuten√ß√£o", vinculo: "", carga: "" },
      "328": { nome: "Claudia da Silva Novais", funcao: "Diretor Escolar", vinculo: "", carga: "20h" },
      "1547": { nome: "Danilo Marinho Ramos", funcao: "Professor", vinculo: "", carga: "40h" },
      "151": { nome: "Edilene Santana de Brito Maia", funcao: "Professor", vinculo: "", carga: "20h" },
      "1550": { nome: "Emily Karoline Oliveira Pimentel Lima", funcao: "Professor", vinculo: "", carga: "40h" },
      "535": { nome: "Fabio Almeida de Oliveira", funcao: "Motorista", vinculo: "", carga: "" },
      "81": { nome: "Leila Soares Santana", funcao: "Diretor Pedagogico", vinculo: "", carga: "20h" },
      "530": { nome: "Luzinete Morais Santos", funcao: "Assistente de Manuten√ß√£o", vinculo: "", carga: "" }
    };

    // ======= UTIL =======
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function defaultPeriodo(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    function showMsg(el, text, type){
      el.className = "msg " + (type || "");
      el.textContent = text;
      el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, 7000);
    }

    // ======= HIST√ìRICO LOCAL =======
    function getHistory(){
      try { return JSON.parse(localStorage.getItem("semec_envios") || "[]"); }
      catch { return []; }
    }
    function setHistory(arr){
      localStorage.setItem("semec_envios", JSON.stringify(arr));
    }
    function addHistory(item){
      const arr = getHistory();
      arr.unshift(item);
      setHistory(arr.slice(0, 150));
    }
    function renderHistory(){
      const arr = getHistory();
      if(!arr.length){
        listaEnvios.innerHTML = `<tr><td colspan="5" class="hint">Nenhum envio ainda.</td></tr>`;
        return;
      }
      listaEnvios.innerHTML = arr.map(it => `
        <tr>
          <td>${escapeHtml(it.periodo)}</td>
          <td>${escapeHtml(it.matricula)}</td>
          <td>${escapeHtml(it.nome)}</td>
          <td>${Number(it.faltas ?? 0)}</td>
          <td>${Number(it.horas_extras ?? 0)}</td>
        </tr>
      `).join("");
    }

    // ======= SENHA DE ACESSO =======
    function unlockIfOk(){
      const v = String(senhaAcesso.value || "");
      if(v === SENHA_ACESSO){
        lockOverlay.style.display = "none";
        localStorage.setItem("semec_folha_unlock", "1");
      } else {
        senhaErr.style.display = "block";
        senhaAcesso.focus();
      }
    }

    btnEntrar.addEventListener("click", unlockIfOk);
    senhaAcesso.addEventListener("keydown", (e) => {
      if(e.key === "Enter") unlockIfOk();
    });

    // ======= CHECK API =======
    async function checkApi(){
      try{
        const r = await fetch(API_HEALTH, { method:"GET" });
        const j = await r.json().catch(() => ({}));
        if(r.ok && j.ok){
          apiStatus.textContent = j.db ? "online (db ok)" : "online (db off)";
          dotApi.classList.remove("bad");
          dotApi.classList.add("ok");
        } else {
          apiStatus.textContent = "online?";
          dotApi.classList.remove("ok");
          dotApi.classList.add("bad");
        }
      }catch{
        apiStatus.textContent = "offline?";
        dotApi.classList.remove("ok");
        dotApi.classList.add("bad");
      }
    }

    // ======= AUTOCOMPLETE (datalist) =======
    function fillDatalist(prefix){
      const p = String(prefix || "").trim().toLowerCase();
      const opts = [];

      for(const [mat, info] of Object.entries(FUNCIONARIOS)){
        const n = (info.nome || "").toLowerCase();

        // se digitou n√∫mero (matr√≠cula) ou letra (nome), filtra
        if(!p || mat.startsWith(p) || n.startsWith(p)){
          opts.push({ mat, nome: info.nome });
        }
      }

      // limita pra n√£o ficar gigante
      const top = opts.slice(0, 25);

      listaNomes.innerHTML = top.map(x => `
        <option value="${escapeHtml(x.mat)} - ${escapeHtml(x.nome)}"></option>
      `).join("");
    }

    function applyFuncionarioByMat(mat){
      const info = FUNCIONARIOS[String(mat)];
      if(!info) return false;

      matricula.value = String(mat);
      nome.value = info.nome || "";
      funcao.value = info.funcao || "";
      vinculo.value = info.vinculo || "";
      carga.value = info.carga || "";
      return true;
    }

    function tryApplyFromBusca(){
      const v = String(busca.value || "").trim();
      if(!v) return;

      // formatos aceitos:
      // "396" OU "396 - Nome" OU "Nome"
      const maybeMat = v.split(" - ")[0].trim();

      // se √© n√∫mero, tenta como matr√≠cula
      if(/^\d+$/.test(maybeMat)){
        if(applyFuncionarioByMat(maybeMat)) return;
      }

      // se digitou nome, acha o primeiro que come√ßa com isso
      const n = v.toLowerCase();
      for(const [mat, info] of Object.entries(FUNCIONARIOS)){
        if((info.nome || "").toLowerCase().startsWith(n)){
          applyFuncionarioByMat(mat);
          return;
        }
      }
    }

    busca.addEventListener("input", () => {
      fillDatalist(busca.value);
    });
    busca.addEventListener("change", () => {
      tryApplyFromBusca();
    });

    // se digitar matr√≠cula direto, preenche
    matricula.addEventListener("input", () => {
      const m = matricula.value.trim();
      if(/^\d+$/.test(m) && FUNCIONARIOS[m]){
        applyFuncionarioByMat(m);
      }
    });

    // ======= FALTAS (AUTO) =======
    function recalcFaltas(){
      let comA = Number(falta_com_atestado.value || 0);
      let semA = Number(falta_sem_atestado.value || 0);

      // clamp 0-15
      comA = Math.max(0, Math.min(15, comA));
      semA = Math.max(0, Math.min(15, semA));

      falta_com_atestado.value = String(comA);
      falta_sem_atestado.value = String(semA);

      total_faltas.value = String(comA + semA);
    }
    falta_com_atestado.addEventListener("input", recalcFaltas);
    falta_sem_atestado.addEventListener("input", recalcFaltas);

    // ======= LIMPAR =======
    function clearForm(){
      escola.value = "";
      busca.value = "";
      matricula.value = "";
      nome.value = "";
      funcao.value = "";
      vinculo.value = "";
      carga.value = "";
      horas_extras.value = "0";
      falta_com_atestado.value = "0";
      falta_sem_atestado.value = "0";
      total_faltas.value = "0";
      observacoes.value = "";
      recalcFaltas();
    }

    btnLimpar.addEventListener("click", () => {
      clearForm();
      showMsg(msgBox, "üßπ Campos limpos.", "");
    });

    // ======= VALIDAR =======
    function validate(){
      if(!periodo.value) periodo.value = defaultPeriodo();
      if(!escola.value.trim()) return "Informe a escola.";
      if(!matricula.value.trim()) return "Informe a matr√≠cula (ou selecione no campo Buscar).";
      if(!nome.value.trim()) return "Informe o nome do funcion√°rio.";
      return null;
    }

    // ======= ENVIAR =======
    async function enviar(){
      const err = validate();
      if(err){
        showMsg(msgBox, "‚ùå " + err, "err");
        return;
      }

      recalcFaltas();

      const body = {
        periodo: periodo.value,
        matricula: matricula.value.trim(),

        // dados do cadastro (atualiza no admin)
        nome: nome.value.trim(),
        funcao: funcao.value.trim(),
        vinculo: vinculo.value.trim(),
        carga: carga.value.trim(),
        escola: escola.value.trim(),

        // folha
        faltas: Number(total_faltas.value || 0),
        falta_sem_atestado: Number(falta_sem_atestado.value || 0),
        horas_extras: Number(horas_extras.value || 0),
        observacoes: (observacoes.value || "").trim(),
      };

      btnEnviar.disabled = true;
      btnEnviar.textContent = "Enviando...";

      try{
        const r = await fetch(API_ENVIAR, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if(r.status === 404){
          showMsg(msgBox, "‚ùå Erro 404: rota n√£o encontrada. Confirme no servidor: POST " + API_ENVIAR, "err");
          return;
        }

        const j = await r.json().catch(() => ({}));
        if(!r.ok){
          showMsg(msgBox, "‚ùå " + (j.error || "Falha ao enviar."), "err");
          return;
        }

        addHistory({
          periodo: body.periodo,
          matricula: body.matricula,
          nome: body.nome,
          faltas: body.faltas,
          horas_extras: body.horas_extras,
          quando: new Date().toISOString()
        });

        renderHistory();
        showMsg(msgBox, "‚úÖ Enviado com sucesso! Cadastro atualizado no Admin.", "ok");
        clearForm();

      }catch(e){
        showMsg(msgBox, "‚ùå Erro de conex√£o: " + (e?.message || "n√£o foi poss√≠vel enviar"), "err");
      }finally{
        btnEnviar.disabled = false;
        btnEnviar.textContent = "üì© Enviar para ADM";
      }
    }

    btnEnviar.addEventListener("click", enviar);

    // ======= HIST√ìRICO =======
    btnAtualizarLista.addEventListener("click", () => {
      renderHistory();
      showMsg(msgList, "üîÑ Lista atualizada.", "ok");
    });

    btnLimparHistorico.addEventListener("click", () => {
      setHistory([]);
      renderHistory();
      showMsg(msgList, "üóëÔ∏è Hist√≥rico apagado.", "");
    });

    // ======= INIT =======
    (function init(){
      // senha (lembrar no navegador)
      if(localStorage.getItem("semec_folha_unlock") === "1"){
        lockOverlay.style.display = "none";
      } else {
        senhaAcesso.focus();
      }

      periodo.value = defaultPeriodo();
      horas_extras.value = "0";
      falta_com_atestado.value = "0";
      falta_sem_atestado.value = "0";
      recalcFaltas();

      fillDatalist("");
      renderHistory();
      checkApi();
      setInterval(checkApi, 20000);
    })();
  </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEMEC - Folha</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

h1 {
    text-align: center;
    color: #2c3e50;
}

input, select, button, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 15px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 15px;
}

button {
    background: #2c3e50;
    color: white;
    cursor: pointer;
    border: none;
}

button:hover {
    background: #34495e;
}

.resultado {
    background: #eef2f7;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
}
</style>
</head>

<body>
<div class="container">
<h1>Folha de Lançamento</h1>

<label>Pesquisar Funcionário (Nome ou Matrícula)</label>
<input type="text" id="busca" placeholder="Digite nome ou matrícula">
<button onclick="buscarFuncionario()">Buscar</button>

<div id="resultadoBusca"></div>

<div id="formLancamento" style="display:none;">
<hr>

<h3>Lançamento</h3>

<label>Mês (YYYY-MM)</label>
<input type="month" id="mes">

<label>Faltas</label>
<input type="number" id="faltas" min="0" value="0">

<label>Faltas com Atestado</label>
<input type="number" id="faltas_atestado" min="0" value="0">

<label>Horas Extras</label>
<input type="number" id="horas_extras" min="0" value="0">

<label>Observações</label>
<textarea id="obs"></textarea>

<button onclick="enviarLancamento()">Enviar Lançamento</button>

</div>
</div>

<script>
let funcionarioSelecionado = null;

async function buscarFuncionario() {
    const q = document.getElementById("busca").value;

    const res = await fetch(`https://semec-sistema.onrender.com/api/funcionarios/search?q=${q}`);
    const data = await res.json();

    const div = document.getElementById("resultadoBusca");
    div.innerHTML = "";

    if (!data.data || data.data.length === 0) {
        div.innerHTML = "<p>Nenhum funcionário encontrado.</p>";
        return;
    }

    data.data.forEach(func => {
        const btn = document.createElement("button");
        btn.innerText = `${func.nome} (${func.matricula})`;
        btn.onclick = () => selecionarFuncionario(func);
        div.appendChild(btn);
    });
}

function selecionarFuncionario(func) {
    funcionarioSelecionado = func;
    document.getElementById("formLancamento").style.display = "block";
}
  if (!funcionarioSelecionado) {
    alert("Selecione um funcionário primeiro");
    return;
}

const mes = document.getElementById("mes").value;
const faltas = document.getElementById("faltas").value || 0;
const faltas_atestado = document.getElementById("faltas_atestado").value || 0;
const horas_extras = document.getElementById("horas_extras").value || 0;
const obs = document.getElementById("obs").value;

if (!mes) {
    alert("Informe o mês");
    return;
}

const res = await fetch("https://semec-sistema.onrender.com/api/folha/lancar", {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
  
    body: JSON.stringify({
        matricula: funcionarioSelecionado.matricula,
        mes,
        faltas,
        faltas_atestado,
        horas_extras,
        obs
    })
});

const data = await res.json();

if (data.ok) {
    alert("Lançamento salvo com sucesso!");
    document.getElementById("faltas").value = 0;
    document.getElementById("faltas_atestado").value = 0;
    document.getElementById("horas_extras").value = 0;
    document.getElementById("obs").value = "";
} else {
    alert("Erro ao salvar");
}
  </body>
</html>
